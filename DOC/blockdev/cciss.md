# 此驱动程序适用于 Compaq 的 SMART 阵列控制器。

# 支持的卡：

----------------

已知此驱动程序可与以下卡配合使用：

```
    * SA 5300
    * SA 5i
    * SA 532
    * SA 5312
    * SA 641
    * SA 642
    * SA 6400
    * SA 6400 U320 扩展模块
    * SA 6i
    * SA P600
    * SA P800
    * SA E400
    * SA P400i
    * SA E200
    * SA E200i
    * SA E500
    * SA P700m
    * SA P212
    * SA P410
    * SA P410i
    * SA P411
    * SA P812
    * SA P712m
```

# 检测驱动器故障：

-------------------------

要获取逻辑卷的状态并检测物理驱动器故障，您可以使用在此处找到的`cciss_vol_status`程序：http://cciss.sourceforge.net/#cciss_utils

设备命名：

--------------

如果在`/dev/cciss`目录中尚未创建节点，请以 root 身份运行：

`# cd /dev`

`#./MAKEDEV cciss`

您需要在`/dev`中为`cciss`设备添加一些条目。`MAKEDEV`脚本可以自动为您创建设备节点。目前设备设置如下：

主编号：

```
    104  cciss0
    105  cciss1
    106  cciss2
    105  cciss3
    108  cciss4
    109  cciss5
    110  cciss6
    111  cciss7
```

次编号：

```
        b7 b6 b5 b4 b3 b2 b1 b0
        |----+----| |----+----|
             |           |
             |           +-------- 分区 ID（0 = 整个设备，1-15 分区）
             |
             +-------------------- 逻辑卷编号
```

设备命名方案是：

```
/dev/cciss/c0d0            控制器 0，磁盘 0，整个设备
/dev/cciss/c0d0p1          控制器 0，磁盘 0，分区 1
/dev/cciss/c0d0p2          控制器 0，磁盘 0，分区 2
/dev/cciss/c0d0p3          控制器 0，磁盘 0，分区 3
/dev/cciss/c1d1            控制器 1，磁盘 1，整个设备
/dev/cciss/c1d1p1          控制器 1，磁盘 1，分区 1
/dev/cciss/c1d1p2          控制器 1，磁盘 1，分区 2
/dev/cciss/c1d1p3          控制器 1，磁盘 1，分区 3
```

# CCISS 简单模式支持

-------------------------

可以使用“`cciss_simple_mode=1`”引导参数来防止驱动程序将控制器置于“高性能”模式。区别在于，在简单模式下，每个命令完成都需要一个中断，而在“高性能模式”（默认模式，通常性能更好）下，可能会有多个命令完成由一个中断指示。

# SCSI 磁带驱动器和介质更换器支持

------------------------------------------

支持 SCSI 顺序访问设备和介质更换器设备，并且会自动创建相应的设备节点。（例如`/dev/st0`、`/dev/st1`等。有关更多详细信息，请参阅“`st`”手册页。）

您必须在内核配置中启用“Smart Array 5xxx 的 SCSI 磁带驱动器支持”和“SCSI 支持”，才能在 Smart Array 5xxx 控制器上使用 SCSI 磁带驱动器。

此外，请注意，驱动程序在初始化时如果检测到任何磁带驱动器或介质更换器，将启动 SCSI 核心。驱动程序也可以通过`/proc`文件系统条目动态启动 SCSI 核心，该条目由驱动程序的“块”侧在运行时在`/proc/driver/cciss/cciss*`处创建。这最好通过脚本完成。

例如：

```
for x in /proc/driver/cciss/cciss[0-9]*
do
    echo "engage scsi" > $x
done
```

一旦驱动程序启动了 SCSI 核心，就不能将其解除启动（除非卸载驱动程序，如果它恰好作为模块链接。）

还要注意，如果未检测到顺序访问设备或介质更换器，上述脚本的操作将不会启动 SCSI 核心。

# SCSI 磁带驱动器的热插拔支持

-------------------------------------

支持 SCSI 磁带驱动器的热插拔，但有一些注意事项。必须通知`cciss`驱动程序 SCSI 总线已发生更改。这可以通过`/proc`文件系统完成。例如：

```
echo "rescan" > /proc/scsi/cciss0/1
```

这将导致驱动程序查询适配器有关物理 SCSI 总线和/或光纤通道仲裁环的更改，并记录任何新添加或删除的顺序访问设备或介质更换器。驱动程序将输出指示已添加或删除哪些设备以及用于寻址设备的控制器、总线、目标和 lun 的消息。然后，它将这些更改通知 SCSI 中间层。

请注意，`/proc`文件系统条目的命名约定除了驱动程序名称外还包含一个数字。（例如“cciss0”而不是您可能期望的“cciss”。）

注意：`cciss`驱动程序仅将顺序访问设备和介质更换器作为 SCSI 设备呈现给 SCSI 中间层。具体而言，物理 SCSI 磁盘驱动器不会呈现给 SCSI 中间层。物理 SCSI 磁盘驱动器由阵列控制器硬件直接控制，重要的是要防止内核尝试直接访问这些设备，就像我们允许阵列控制器以与访问 SCSI 磁带驱动器相同的方式充当 SCSI 控制器一样。

# SCSI 错误处理（磁带驱动器和介质更换器）

-------------------------------------------------------

Linux SCSI 中间层提供了一个错误处理协议，每当 SCSI 命令在一定时间内未完成（这可能因命令而异）时，该协议就会启动。`cciss`驱动程序在一定程度上参与了此协议。

正常协议是一个四步过程。首先，告诉设备中止命令。如果这不起作用，则重置设备。如果这不起作用，则重置 SCSI 总线。如果这不起作用，则重置主机总线适配器。由于`cciss`驱动程序既是块驱动程序又是 SCSI 驱动程序，并且仅将磁带驱动器和介质更换器呈现给 SCSI 中间层，并且与更直接的 SCSI 驱动程序不同，在 SCSI 错误恢复过程中，磁盘 I/O 会通过块侧继续，`cciss`驱动程序仅实现这些操作中的前两个，即中止命令和重置设备。此外，大多数磁带驱动器不会配合中止命令，有时似乎它们甚至不会遵守重置命令，尽管在大多数情况下它们会。在无法中止命令且设备无法重置的情况下，设备将被设置为离线。

如果错误处理代码被触发并且磁带驱动器成功重置或延迟命令成功中止，磁带驱动器可能仍然不允许 I/O 继续，直到发出将磁带定位到已知位置的命令。通常，在 I/O 可以再次继续到已重置的磁带驱动器之前，您必须倒带磁带（例如，通过发出“`mt -f /dev/st0 rewind`”）。

有一个`cciss_tape_cmds`模块参数可用于使`cciss`为磁带驱动器分配更多命令。通常，仅为磁带驱动器分配几个命令（6 个），因为磁带驱动器速度慢且不常使用，并且 Smart Array 控制器的主要目的是充当磁盘驱动器的 RAID 控制器，因此绝大多数命令都分配给磁盘设备。但是，如果您在智能阵列上连接了多个磁带驱动器，默认命令数量可能不够（例如，如果您有 8 个磁带驱动器，使用默认命令数量一次只能倒带 6 个。）`cciss_tape_cmds`模块参数允许为磁带驱动器分配更多命令（最多 16 个）。例如：

        insmod cciss.ko cciss_tape_cmds=16

或者，作为通过 grub 传递的内核引导参数：cciss.cciss_tape_cmds=8