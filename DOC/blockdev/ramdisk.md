在 Linux 中使用 RAM 磁盘块设备

------------------------------------------

# 内容：

1. 概述

2. 内核命令行参数

3. 使用“rdev -r”

4. 创建压缩 RAM 磁盘的示例

# 1. 概述

-----------

RAM 磁盘驱动程序是一种将主系统内存用作块设备的方法。它是 initrd 所必需的，如果需要加载模块才能访问根文件系统（请参阅 Documentation/initrd.txt），则 initrd 是一个初始文件系统。它还可用于加密工作的临时文件系统，因为内容在重新启动时会被擦除。

RAM 磁盘会随着需要更多空间而动态增长。它通过使用缓冲区缓存中的 RAM 来实现这一点。驱动程序将其使用的缓冲区标记为脏，以便 VM 子系统稍后不会尝试回收它们。

默认情况下，RAM 磁盘最多支持 16 个 RAM 磁盘，并且可以重新配置以支持无限数量的 RAM 磁盘（自行承担风险）。只需在“块驱动程序配置”菜单中更改配置符号 BLK_DEV_RAM_COUNT 并（重新）构建内核。

要在系统中使用 RAM 磁盘支持，请从 /dev 目录运行“./MAKEDEV ram”。RAM 磁盘的主设备号均为 1，从 /dev/ram0 开始，依此类推。如果使用，现代内核将 /dev/ram0 用于 initrd。

新的 RAM 磁盘还具有加载压缩 RAM 磁盘映像的能力，允许在平均安装或救援软盘上容纳更多程序。

# 2. 参数

---------------------------------

## 2a. 内核命令行参数

ramdisk_size=N

==============

此参数告诉 RAM 磁盘驱动程序设置大小为 Nk 的 RAM 磁盘。默认值为 4096（4MB）。

## 2b. 模块参数

rd_nr

=====

创建的 /dev/ramX 设备。

max_part

========

最大分区号。

rd_size

=======

请参阅 ramdisk_size。

# 3. 使用“rdev -r”

------------------

“rdev -r”在内核映像中设置的字（两个字节）的用法如下。低 11 位（0 -> 10）指定一个偏移量（以 1k 块为单位），最多为 2MB（2^11），用于查找 RAM 磁盘（这过去是大小）。位 14 表示要加载 RAM 磁盘，位 15 表示在尝试读取 RAM 磁盘之前是否要给出提示/等待序列。由于 RAM 磁盘在数据被写入时动态增长，因此不需要大小字段。位 11 到 13 目前未使用，最好为零。这些数字不是神奇的秘密，如下所示：

./arch/x86/kernel/setup.c:#define RAMDISK_IMAGE_START_MASK     0x07FF

./arch/x86/kernel/setup.c:#define RAMDISK_PROMPT_FLAG          0x8000

./arch/x86/kernel/setup.c:#define RAMDISK_LOAD_FLAG            0x4000

考虑一个典型的双软盘设置，其中内核在磁盘 1 上，并且已经将 RAM 磁盘映像放在磁盘 #2 上。

因此，您希望将位 0 到 13 设置为 0，这意味着您的 RAM 磁盘从软盘开头的 0kB 偏移量开始。等效的命令行是：“ramdisk_start=0”

您希望位 14 为 1，表示要加载 RAM 磁盘。等效的命令行是：“load_ramdisk=1”

您希望位 15 为 1，表示您希望有一个提示/按键序列，以便有机会切换软盘。等效的命令行是：“prompt_ramdisk=1”

将这些组合在一起，得到 2^15 + 2^14 + 0 = 49152 的 rdev 字。因此，要创建该组的磁盘 1，您可以执行：

/usr/src/linux# cat arch/x86/boot/zImage > /dev/fd0

/usr/src/linux# rdev /dev/fd0 /dev/fd0

/usr/src/linux# rdev -r /dev/fd0 49152

如果您制作一个带有 LILO 的引导盘，对于上述内容，您可以使用：

append = "ramdisk_start=0 load_ramdisk=1 prompt_ramdisk=1"

由于默认 start = 0 和默认 prompt = 1，您可以使用：

append = "load_ramdisk=1"

# 4. 创建压缩 RAM 磁盘的示例

----------------------------------------------

要创建 RAM 磁盘映像，您需要一个备用块设备来构建它。这可以是 RAM 磁盘设备本身，也可以是一个未使用的磁盘分区（例如未挂载的交换分区）。对于此示例，我们将使用 RAM 磁盘设备“/dev/ram0”。

注意：此技术不应在内存少于 8MB 的机器上进行。如果使用备用磁盘分区而不是 /dev/ram0，则此限制不适用。

a. 确定您想要的 RAM 磁盘大小。在此示例中为 2MB。通过写入 RAM 磁盘设备来创建它。（此步骤目前不是必需的，但将来可能需要。）明智的做法是将该区域清零（特别是对于磁盘），以便为即将创建的映像的未使用块实现最大压缩。

dd if=/dev/zero of=/dev/ram0 bs=1k count=2048

b. 在其上创建文件系统。在此示例中为 ext2fs。

mke2fs -vm0 /dev/ram0 2048

c. 挂载它，将您想要的文件复制到它（例如：/etc/* /dev/*...），然后再次卸载它。

d. 压缩 RAM 磁盘的内容。压缩级别约为文件使用空间的 50％。RAM 磁盘上的未使用空间将几乎压缩为零。

dd if=/dev/ram0 bs=1k count=2048 | gzip -v9 > /tmp/ram_image.gz

e. 将内核放到软盘上

dd if=zImage of=/dev/fd0 bs=1k

f. 将 RAM 磁盘映像放到软盘上，在内核之后。使用一个略大于内核的偏移量，以便以后可以在同一软盘上放置另一个（可能更大）内核而不会与 RAM 磁盘映像重叠。对于大小约为 350kB 的内核，400kB 的偏移量是合理的。确保 ram_image.gz 的偏移量+大小不大于软盘上的总空间（通常为 1440kB）。

dd if=/tmp/ram_image.gz of=/dev/fd0 bs=1k seek=400

g. 使用“rdev”设置引导设备、RAM 磁盘偏移量、提示标志等。对于 prompt_ramdisk=1，load_ramdisk=1，ramdisk_start=400，将有 2^15 + 2^14 + 400 = 49552。

rdev /dev/fd0 /dev/fd0

rdev -r /dev/fd0 49552

就是这样。现在您有了引导/根压缩 RAM 磁盘软盘。一些用户可能希望通过使用管道将步骤（d）和（f）组合在一起。

--------------------------------------------------------------------------

						Paul Gortmaker 12/95

# 更改日志：

----------

10-22-04 : 更新以反映命令行选项的更改，删除过时的引用，进行常规清理。 		James Nelson (james4765@gmail.com)

12-95 : 原始文档