# ACPI 视频扩展

此驱动程序实现了主板上集成图形设备的显示适配器的 ACPI 扩展，如 ACPI 2.0 规范附录 B 中所指定的那样，允许执行一些基本控制，如定义视频 POST 设备、检索 EDID 信息或设置视频输出等。请注意，这只是一个参考实现。它可能适用于您的集成视频设备，也可能不适用。

ACPI 视频驱动程序在背光控制方面做了 3 件事：

## 1. 为用户空间导出一个 sysfs 接口来控制背光级别

如果 ACPI 表有一个视频设备，并且不存在 acpi_backlight=vendor 内核命令行，则驱动程序将注册一个背光设备，并为其设置所需的背光操作结构，以用于 sysfs 接口控制。对于每个注册的类设备，在 /sys/class/backlight 下将有一个名为 acpi_videoX 的目录。

背光 sysfs 接口在此处有一个标准定义：Documentation/ABI/stable/sysfs-class-backlight。

ACPI 视频驱动程序所做的是：

actual_brightness：在读取时，将评估控制方法 _BQC 以获取固件认为的亮度级别；

bl_power：未实现，将设置当前亮度；

brightness：在写入时，控制方法 _BCM 将运行以设置请求的亮度级别；

max_brightness：从 _BCL 包中派生（见下文）；

type：固件

请注意，ACPI 视频背光驱动程序始终将索引用于亮度、actual_brightness 和 max_brightness。因此，如果我们有以下 _BCL 包：

```
Method (_BCL, 0, NotSerialized)
{
	Return (Package (0x0C)
	{
		0x64,
		0x32,
		0x0A,
		0x14,
		0x1E,
		0x28,
		0x32,
		0x3C,
		0x46,
		0x50,
		0x5A,
		0x64
	})
}
```

前两个级别是当笔记本电脑接通交流电源或电池时使用的，但目前 Linux 未使用。其余 10 个级别是我们可以选择的支持级别。适用的索引值从 0（对应于 0x0A 亮度值）到 9（对应于 0x64 亮度值），包括在内。这些索引值中的每一个都被视为“亮度级别”指示器。因此，从用户空间的角度来看，可用亮度级别的范围从 0 到 9（max_brightness），包括在内。

## 2. 向用户空间通知热键事件

热键事件报告通常有两种情况：

i) 对于某些笔记本电脑，当用户按下热键时，将生成一个扫描码，并通过键盘驱动程序创建的输入设备作为键类型输入事件发送到用户空间，经过适当的重新映射，以下键码将出现在用户空间：

```
    EV_KEY, KEY_BRIGHTNESSUP
    EV_KEY, KEY_BRIGHTNESSDOWN
    等。
```
	
对于这种情况，ACPI 视频驱动程序不需要做任何事情（实际上，它甚至不知道这已经发生）。

ii) 对于某些笔记本电脑，按下热键不会生成扫描码，而是，固件将向视频设备 ACPI 节点通知该事件。事件值在 ACPI 规范中定义。ACPI 视频驱动程序将根据接收到的通知值生成一个键类型输入事件，并通过它创建的输入设备将事件发送到用户空间：

```
    事件		    键码
    0x86		KEY_BRIGHTNESSUP
    0x87		KEY_BRIGHTNESSDOWN
    等。
```
	
这样就会产生与情况 i) 相同的效果。

一旦用户空间工具接收到此事件，它可以通过 sysfs 接口修改背光级别。

## 3. 在内核中更改背光级别

这适用于第 2 节中情况 ii) 所涵盖的机器。一旦驱动程序收到通知，它将相应地设置背光级别。这不会影响事件发送到用户空间，无论视频模块是否直接控制背光级别，它们总是发送到用户空间。此行为可以通过 kernel-parameters.txt 中记录的 brightness_switch_enabled 模块参数进行控制。建议在 GUI 环境启动并希望完全控制背光级别后禁用此行为。