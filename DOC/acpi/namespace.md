# ACPI 设备树 - ACPI 命名空间的表示

版权所有 (C) 2013，英特尔公司

作者：Lv Zheng <lv.zheng@intel.com>

## 摘要：

Linux ACPI 子系统将 ACPI 命名空间对象转换为 /sys/devices/LNXSYSTEM:00 下的 Linux 设备树，并在接收到 ACPI 热插拔通知事件时更新它。对于此层次结构中的每个设备对象，在 /sys/bus/acpi/devices 中都有一个相应的符号链接。本文档说明了 ACPI 设备树的结构。

## 致谢：

感谢 Zhang Rui <rui.zhang@intel.com> 和 Rafael J. Wysocki <rafael.j.wysocki@intel.com> 的帮助。

## 1. ACPI 定义块

ACPI 固件在系统内存地址空间中设置 RSDP（根系统描述指针），指向 XSDT（扩展系统描述表）。XSDT 始终使用其第一个条目指向 FADT（固定 ACPI 描述表），FADT 中的数据包括描述硬件固定 ACPI 功能的各种固定长度条目。FADT 包含指向 DSDT（差异化系统描述表）的指针。XSDT 还包含指向可能多个 SSDT（辅助系统描述表）的条目。

DSDT 和 SSDT 数据以称为定义块的数据结构组织，其中包含各种对象的定义，包括用 AML（ACPI 机器语言）编码的 ACPI 控制方法。DSDT 的数据块以及 SSDT 的内容表示一个称为 ACPI 命名空间的分层数据结构，其拓扑结构反映了底层硬件平台的结构。

上述 ACPI 系统定义表之间的关系在下图中说明。

```
     +---------+    +-------+    +--------+    +------------------------+
     |  RSDP   | +->| XSDT  | +->|  FADT  |    |  +-------------------+ |
     +---------+ |  +-------+ |  +--------+  +-|->|       DSDT        | |
     | Pointer | |  | Entry |-+  | ...... |  | |  +-------------------+ |
     +---------+ |  +-------+    | X_DSDT |--+ |  | Definition Blocks | |
     | Pointer |-+  | ..... |    | ...... |    |  +-------------------+ |
     +---------+    +-------+    +--------+    |  +-------------------+ |
                    | Entry |------------------|->|       SSDT        | |
                    +- - - -+                  |  +-------------------| |
                    | Entry | - - - - - - - -+ |  | Definition Blocks | |
                    +- - - -+                | |  +-------------------+ |
                                             | |  +- - - - - - - - - -+ |
                                             +-|->|       SSDT        | |
                                               |  +-------------------+ |
                                               |  | Definition Blocks | |
                                               |  +- - - - - - - - - -+ |
                                               +------------------------+
                                                           |
                                              OSPM 加载     |
                                                          \|/
                                                    +----------------+
                                                    | ACPI 命名空间    |
                                                    +----------------+
```

图 1. ACPI 定义块

注意：RSDP 还可以包含指向 RSDT（根系统描述表）的指针。平台提供 RSDT 以实现与 ACPI 1.0 操作系统的兼容性。如果存在，操作系统应使用 XSDT。

## 2. 示例 ACPI 命名空间

所有定义块都加载到单个命名空间中。命名空间是一个由名称和路径标识的对象层次结构。以下命名约定适用于 ACPI 命名空间中的对象名称：

1. 所有名称均为 32 位长。

2. 名称的第一个字节必须是 'A' - 'Z'、'_' 之一。

3. 名称的其余每个字节必须是 'A' - 'Z'、'0' - '9'、'_' 之一。

4. 以 '_' 开头的名称由 ACPI 规范保留。

5. '\' 符号表示命名空间的根（即，以 '\' 开头的名称相对于命名空间根）。

6. '^' 符号表示当前命名空间节点的父节点（即，以 '^' 开头的名称相对于当前命名空间节点的父节点）。

下图显示了一个示例 ACPI 命名空间。

```
   +------+
   | \    |                     根
   +------+
     |
     | +------+
     +-| _PR  |                 范围(_PR)：处理器命名空间
     | +------+
     |   |
     |   | +------+
     |   +-| CPU0 |             处理器(CPU0)：第一个处理器
     |     +------+
     |
     | +------+
     +-| _SB  |                 范围(_SB)：系统总线命名空间
     | +------+
     |   |
     |   | +------+
     |   +-| LID0 |             设备(LID0)；盖子设备
     |   | +------+
     |   |   |
     |   |   | +------+
     |   |   +-| _HID |         名称(_HID, "PNP0C0D")：硬件 ID
     |   |   | +------+
     |   |   |
     |   |   | +------+
     |   |   +-| _STA |         方法(_STA)：状态控制方法
     |   |     +------+
     |   |
     |   | +------+
     |   +-| PCI0 |             设备(PCI0)；PCI 根桥
     |     +------+
     |       |
     |       | +------+
     |       +-| _HID |         名称(_HID, "PNP0A08")：硬件 ID
     |       | +------+
     |       |
     |       | +------+
     |       +-| _CID |         名称(_CID, "PNP0A03")：兼容 ID
     |       | +------+
     |       |
     |       | +------+
     |       +-| RP03 |         范围(RP03)：PCI0 电源范围
     |       | +------+
     |       |   |
     |       |   | +------+
     |       |   +-| PXP3 |     电源资源(PXP3)：PCI0 电源资源
     |       |     +------+
     |       |
     |       | +------+
     |       +-| GFX0 |             设备(GFX0)：图形适配器
     |         +------+
     |           |
     |           | +------+
     |           +-| _ADR |     名称(_ADR, 0x00020000)：PCI 总线地址
     |           | +------+
     |           |
     |           | +------+
     |           +-| DD01 |     设备(DD01)：LCD 输出设备
     |             +------+
     |               |
     |               | +------+
     |               +-| _BCL | 方法(_BCL)：背光控制方法
     |                 +------+
     |
     | +------+
     +-| _TZ  |                 范围(_TZ)：热区命名空间
     | +------+
     |   |
     |   | +------+
     |   +-| FN00 |             电源资源(FN00)：FAN0 电源资源
     |   | +------+
     |   |
     |   | +------+
     |   +-| FAN0 |             设备(FAN0)：FAN0 冷却设备
     |   | +------+
     |   |   |
     |   |   | +------+
     |   |   +-| _HID |         名称(_HID, "PNP0A0B")：硬件 ID
     |   |     +------+
     |   |
     |   | +------+
     |   +-| TZ00 |             热区(TZ00)；FAN 热区
     |     +------+
     |
     | +------+
     +-| _GPE |                 范围(_GPE)：GPE 命名空间
       +------+
```

图 2. 示例 ACPI 命名空间

## 3. Linux ACPI 设备对象

Linux 内核的核心 ACPI 子系统为表示设备、电源资源、处理器、热区的 ACPI 命名空间对象创建 struct acpi_device 对象。这些对象通过 sysfs 作为 /sys/devices/LNXSYSTM:00 下的子树中的目录导出到用户空间。以下是转换后的 Markdown 格式内容：

**关于名称格式**

它们的名称格式为<bus_id:instance>，其中“bus_id”指给定对象的 ACPI 命名空间表示，“instance”用于区分相同“bus_id”的不同对象（是无符号整数的两位十进制表示）。

“bus_id”的值取决于其所在行所表示的对象类型，如下表所示：

```
                +---+-----------------+-------+----------+
                |   | Object/Feature  | Table | bus_id   |
                +---+-----------------+-------+----------+
                | N | Root            | xSDT  | LNXSYSTM |
                +---+-----------------+-------+----------+
                | N | Device          | xSDT  | _HID     |
                +---+-----------------+-------+----------+
                | N | Processor       | xSDT  | LNXCPU   |
                +---+-----------------+-------+----------+
                | N | ThermalZone     | xSDT  | LNXTHERM |
                +---+-----------------+-------+----------+
                | N | PowerResource   | xSDT  | LNXPOWER |
                +---+-----------------+-------+----------+
                | N | Other Devices   | xSDT  | device   |
                +---+-----------------+-------+----------+
                | F | PWR_BUTTON      | FADT  | LNXPWRBN |
                +---+-----------------+-------+----------+
                | F | SLP_BUTTON      | FADT  | LNXSLPBN |
                +---+-----------------+-------+----------+
                | M | Video Extension | xSDT  | LNXVIDEO |
                +---+-----------------+-------+----------+
                | M | ATA Controller  | xSDT  | LNXIOBAY |
                +---+-----------------+-------+----------+
                | M | Docking Station | xSDT  | LNXDOCK  |
                +---+-----------------+-------+----------+
```

表 1. ACPI 命名空间对象映射

根据 ACPI 系统描述表的内容创建 struct acpi_device 对象时，遵循以下规则（如表格第一列的字母和第二列的表示所示）：

```
N：
	对象的源是 ACPI 命名空间节点（如第二列中命名对象的类型所示）。在这种情况下，其 sysfs 中的目录将包含“path”属性，其值是从命名空间根到该节点的完整路径。

F：
	为固定硬件特性创建 struct acpi_device 对象（如第二列中固定特性标志的名称所示），因此其 sysfs 目录将不包含“path”属性。

M：
	为具有特定控制方法的 ACPI 命名空间节点创建 struct acpi_device 对象（如第二列中 ACPI 定义设备的类型所示）。其 sysfs 目录中将包含其命名空间路径的“path”属性。例如，如果某个 ACPI 命名空间节点存在 _BCL 方法，则将为其创建 bus_id 为 LNXVIDEO 的 struct acpi_device 对象。
```

上述表格的第三列指示了用于创建由给定行表示的 struct acpi_device 对象的 ACPI 系统描述表中的信息（xSDT 表示 DSDT 或 SSDT）。

上述表格的第四列指示了 struct acpi_device 对象的“bus_id”生成规则：

```
_HID：
	表格最后一列中的 _HID 表示对象的 bus_id 是从相应 ACPI 命名空间节点下的 _HID/_CID 标识对象派生而来。该对象的 sysfs 目录将包含“hid”和“modalias”属性，可用于检索该对象的 _HID 和 _CIDs。

LNXxxxxx：
	具有“LNXxxxxx”形式（伪设备）的 bus_id 的 struct acpi_device 对象也将包含“modalias”属性，在这种情况下，它包含总线 ID 字符串本身。

device：
	表格最后一列中的“device”表示对象的 bus_id 无法从相应 ACPI 命名空间节点的 _HID/_CID 确定，尽管该对象表示一个设备（例如，它可能是具有 _ADR 定义但没有 _HID 或 _CID 的 PCI 设备）。在这种情况下，字符串“device”将用作对象的 bus_id。
```

## 4. Linux ACPI 物理设备粘合

ACPI 设备（即 struct acpi_device）对象可能链接到 Linux 设备层次结构中的其他“物理”设备（例如，PCI 总线上的设备）。如果发生这种情况，意味着该 ACPI 设备对象是以其他方式表示的设备的“伙伴”，用于（1）提供关于该设备的配置信息，这些信息无法通过其他方式获得，以及（2）借助其 ACPI 控制方法对设备进行特定操作。一个 ACPI 设备对象可以以这种方式链接到多个“物理”设备。

如果一个 ACPI 设备对象链接到一个“物理”设备，其 sysfs 目录将包含指向目标设备对象 sysfs 目录的“physical_node”符号链接。反过来，目标设备的 sysfs 目录将包含指向伙伴 ACPI 设备对象 sysfs 目录的“firmware_node”符号链接。链接机制依赖于 ACPI 命名空间提供的设备标识。例如，如果有一个表示 PCI 设备的 ACPI 命名空间对象（即 ACPI 命名空间对象下的设备对象，其 _ADR 返回 0x0002000 且父 PCI 桥的总线号为 0，则代表为该 ACPI 命名空间对象创建的 struct acpi_device 对象的 sysfs 目录将包含指向对应 PCI 设备的 /sys/devices/pci0000:00/0000:00:02:0/ sysfs 目录的“physical_node”符号链接。

链接机制通常是特定于总线的。其实现的核心位于 drivers/acpi/glue.c 文件中，但根据相关的总线类型，在其他地方还有补充部分。例如，PCI 特定的部分位于 drivers/pci/pci-acpi.c 中。

## 5. 示例 Linux ACPI 设备树

对应于图 2 中所示示例 ACPI 命名空间并添加了固定 PWR_BUTTON/SLP_BUTTON 设备的 struct acpi_device 对象的 sysfs 层次结构如下所示。以下是转换后的 Markdown 格式：

```
   +--------------+---+-----------------+
   | LNXSYSTEM:00 | \ | acpi:LNXSYSTEM: |
   +--------------+---+-----------------+
     |
     | +-------------+-----+----------------+
     +-| LNXPWRBN:00 | N/A | acpi:LNXPWRBN: |
     | +-------------+-----+----------------+
     |
     | +-------------+-----+----------------+
     +-| LNXSLPBN:00 | N/A | acpi:LNXSLPBN: |
     | +-------------+-----+----------------+
     |
     | +-----------+------------+--------------+
     +-| LNXCPU:00 | \_PR_.CPU0 | acpi:LNXCPU: |
     | +-----------+------------+--------------+
     |
     | +-------------+-------+----------------+
     +-| LNXSYBUS:00 | \_SB_ | acpi:LNXSYBUS: |
     | +-------------+-------+----------------+
     |   |
     |   | +- - - - - - - +- - - - - - +- - - - - - - -+
     |   +-| PNP0C0D:00 | \_SB_.LID0 | acpi:PNP0C0D: |
     |   | +- - - - - - - +- - - - - - +- - - - - - - -+
     |   |
     |   | +------------+------------+-----------------------+
     |   +-| PNP0A08:00 | \_SB_.PCI0 | acpi:PNP0A08:PNP0A03: |
     |     +------------+------------+-----------------------+
     |       |
     |       | +-----------+-----------------+-----+
     |       +-| device:00 | \_SB_.PCI0.RP03 | N/A |
     |       | +-----------+-----------------+-----+
     |       |   |
     |       |   | +-------------+----------------------+----------------+
     |       |   +-| LNXPOWER:00 | \_SB_.PCI0.RP03.PXP3 | acpi:LNXPOWER: |
     |       |     +-------------+----------------------+----------------+
     |       |
     |       | +-------------+-----------------+----------------+
     |       +-| LNXVIDEO:00 | \_SB_.PCI0.GFX0 | acpi:LNXVIDEO: |
     |         +-------------+-----------------+----------------+
     |           |
     |           | +-----------+-----------------+-----+
     |           +-| device:01 | \_SB_.PCI0.DD01 | N/A |
     |             +-----------+-----------------+-----+
     |
     | +-------------+-------+----------------+
     +-| LNXSYBUS:01 | \_TZ_ | acpi:LNXSYBUS: |
       +-------------+-------+----------------+
         |
         | +-------------+------------+----------------+
         +-| LNXPOWER:0a | \_TZ_.FN00 | acpi:LNXPOWER: |
         | +-------------+------------+----------------+
         |
         | +------------+------------+---------------+
         +-| PNP0C0B:00 | \_TZ_.FAN0 | acpi:PNP0C0B: |
         | +------------+------------+---------------+
         |
         | +-------------+------------+----------------+
         +-| LNXTHERM:00 | \_TZ_.TZ00 | acpi:LNXTHERM: |
           +-------------+------------+----------------+
```

图 3. 示例 Linux ACPI 设备树

注意：每个节点表示为“对象/路径/modalias”，其中：

1. '对象'是 sysfs 中对象目录的名称。

2. '路径'是相应 ACPI 命名空间对象的 ACPI 命名空间路径，由对象的“路径”sysfs 属性返回。

3. 'modalias'是对象的“modalias”sysfs 属性的值（如本文档前面所述）。

注意：N/A 表示设备对象没有“路径”或“modalias”属性。