# 延迟统计

任务在执行时会遇到延迟，当它们等待某些内核资源变得可用时，例如，一个可运行的任务可能会等待一个空闲的 CPU 来运行。每个任务的延迟统计功能用于测量任务在以下情况下所经历的延迟：

a) 等待 CPU（在可运行时）

b) 任务启动的同步块 I/O 完成

c) 交换页面

d) 内存回收

并通过 taskstats 接口将这些统计信息提供给用户空间。这样的延迟为适当设置任务的 CPU 优先级、I/O 优先级和 RSS 限制值提供了反馈。重要任务的长时间延迟可能是提高其相应优先级的触发因素。该功能通过使用 taskstats 接口，还提供了属于一个线程组（对应于传统的 Unix 进程）的所有任务（或线程）的延迟统计汇总。这是一种常见的需要的聚合，由内核更有效地完成。用户空间实用程序，特别是资源管理应用程序，也可以将延迟统计聚合到任意组中。为了实现这一点，任务的延迟统计在其生命周期内以及退出时都可用，确保可以进行连续和完整的监控。

## 接口

延迟统计使用 taskstats 接口，该接口在本目录的另一份文档中有详细描述。Taskstats 向用户空间返回一个通用数据结构，对应于每个进程 ID（pid）和每个线程组 ID（tgid）的统计信息。延迟统计功能填充此结构的特定字段。请参阅

```
     include/linux/taskstats.h
```

以了解与延迟统计相关的字段的描述。它通常将以计数器的形式返回针对 CPU、同步块 I/O、交换、内存回收等的累积延迟。

对一个任务的给定计数器（例如 cpu_delay_total）的两次连续读取的差值将给出该任务在该间隔内等待相应资源所经历的延迟。

当一个任务退出时，包含每个任务统计信息的记录将发送到用户空间，而无需命令。如果它是一个线程组的最后一个退出任务，则也会发送每个 tgid 的统计信息。在 taskstats 接口描述中提供了更多详细信息。

本目录中的 getdelays.c 用户空间实用程序允许运行简单命令并显示相应的延迟统计信息。它还作为使用 taskstats 接口的示例。

## 用法

使用以下配置编译内核：

```
	CONFIG_TASK_DELAY_ACCT=y
	CONFIG_TASKSTATS=y
```

延迟统计在启动时默认启用。要禁用，请在内核启动选项中添加

```
   nodelayacct
```

以下说明假定未执行此操作。

系统启动后，使用类似于 getdelays.c 的实用程序来访问给定任务或任务组（tgid）所看到的延迟。该实用程序还允许执行给定命令并查看相应的延迟。

```
getdelays 命令的一般格式
	getdelays [-t tgid] [-p pid] [-c cmd...]
```

获取系统启动以来 pid 为 10 的延迟

```
#./getdelays -p 10
（输出类似于下一个案例）
```

获取系统启动以来 tgid 为 5 的所有 pid 的延迟总和

```
#./getdelays -t 5
CPU	计数	实际总计	虚拟总计	延迟总计
	7876	92005750	100000000	24001500
IO	计数	延迟总计
	0	0
SWAP	计数	延迟总计
	0	0
RECLAIM	计数	延迟总计
	0	0
```

获取执行给定简单命令时看到的延迟

```
#./getdelays -c ls /
bin   data1  data3  data5  dev  home  media  opt   root  srv        sys  usr
boot  data2  data4  data6  etc  lib   mnt    proc  sbin  subdomain  tmp  var

CPU	计数	实际总计	虚拟总计	延迟总计
	6	4000250		4000000		0
IO	计数	延迟总计
	0	0
SWAP	计数	延迟总计
	0	0
RECLAIM	计数	延迟总计
	0	0
```