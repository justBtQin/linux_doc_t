```
=============================================================================
          MOXA Smartio/Industio 系列设备驱动程序安装指南
		    适用于 Linux 内核 2.4.x、2.6.x
	       版权所有 (C) 2008，Moxa 公司
=============================================================================
日期：01/21/2008

内容

1. 简介
2. 系统要求
3. 安装
    3.1 硬件安装
    3.2 驱动文件
    3.3 设备命名约定
    3.4 模块驱动程序配置
    3.5 Linux 内核 2.4.x 和 2.6.x 的静态驱动程序配置
    3.6 自定义配置
    3.7 验证驱动程序安装
4. 实用程序
5. Setserial
6. 故障排除

-----------------------------------------------------------------------------
```
# 1. 简介
```
    Smartio/Industio/UPCI 系列的 Linux 驱动程序支持以下多端口板卡。

    - 2 端口多端口板卡
        CP-102U、CP-102UL、CP-102UF
        CP-132U-I、CP-132UL、
        CP-132、CP-132I、CP132S、CP-132IS、
        CI-132、CI-132I、CI-132IS、
        (C102H、C102HI、C102HIS、C102P、CP-102、CP-102S)

    - 4 端口多端口板卡
        CP-104EL、
        CP-104UL、CP-104JU、
        CP-134U、CP-134U-I、
        C104H/PCI、C104HS/PCI、
        CP-114、CP-114I、CP-114S、CP-114IS、CP-114UL、
        C104H、C104HS、
        CI-104J、CI-104JS、
        CI-134、CI-134I、CI-134IS、
        (C114HI、CT-114I、C104P)
        POS-104UL、
        CB-114、
        CB-134I

    - 8 端口多端口板卡
        CP-118EL、CP-168EL、
        CP-118U、CP-168U、
        C168H/PCI、
        C168H、C168HS、
        (C168P)、
        CB-108

    此驱动程序和安装过程是基于 Linux 内核 2.4.x 和 2.6.x 开发的。此驱动程序支持英特尔 x86 硬件平台。为了保持兼容性，此版本还在 RedHat、Mandrake、Fedora 和 S.u.S.E Linux 上进行了适当的测试。但是，如果出现兼容性问题，请通过 support@moxa.com.tw 联系 Moxa。

    除了设备驱动程序外，此版本还提供了有用的实用程序。它们是
    - msdiag  用于显示已安装的 Moxa Smartio/Industio 板卡的诊断程序。
    - msmon   用于观察数据计数和线路状态信号的监控程序。
    - msterm  一个在测试串行端口时有用的简单终端程序。
    - io-irq.exe 用于设置 ISA 板卡的配置程序。请注意，此程序只能在 DOS 下执行。

    所有的驱动程序和实用程序都以源代码的形式在 GNU 通用公共许可证下发布。更多详细信息请参考每个源代码文件中的 GNU 通用公共许可证声明。

    在 Moxa 的网站上，您可以在 http://www.moxa.com/ 上始终找到最新的驱动程序。

    此版本的驱动程序可以作为可加载模块（模块驱动程序）或内置到内核（静态驱动程序）进行安装。您可以参考以下安装过程选择合适的方式。在安装驱动程序之前，请参考用户手册中的硬件安装过程。

    我们假设用户应该熟悉以下文档。
    - Serial-HOWTO
    - Kernel-HOWTO

-----------------------------------------------------------------------------
```
# 2. 系统要求
```
    - 硬件平台：英特尔 x86 机器
    - 内核版本：2.4.x 或 2.6.x
    - gcc 版本 2.72 或更高版本
    - 最多可以组合安装 4 个板卡

-----------------------------------------------------------------------------
```
# 3. 安装
```
   3.1 硬件安装
   3.2 驱动文件
   3.3 设备命名约定
   3.4 模块驱动程序配置
   3.5 Linux 内核 2.4.x、2.6.x 的静态驱动程序配置
   3.6 自定义配置
   3.7 验证驱动程序安装
```
## 3.1 硬件安装
```
       Smartio/Industio 系列多端口板卡有两种总线类型，ISA 和 PCI。

       ISA 板
       ---------
       在安装此驱动程序之前，您需要配置 CAP 地址、I/O 地址、中断向量以及 IRQ。在继续操作之前，请参考用户手册中的硬件安装过程。请确保在正确设置 ISA 板后，JP1 是打开的。

       PCI/UPCI 板
       --------------
       您可能需要在 BIOS 中调整 IRQ 使用，以避免与其他 ISA 设备发生 IRQ 冲突。请提前参考用户手册中的硬件安装过程。

       PCI IRQ 共享
       -----------
       同一多端口板内的每个端口共享相同的 IRQ。一个系统中最多可以安装 4 个 Moxa Smartio/Industio PCI 系列多端口板，并且它们可以共享相同的 IRQ。
```
## 3.2 驱动文件
```
       驱动文件可以从 ftp、CD-ROM 或软盘获得。第一步，无论如何，是将驱动文件“mxser.tgz”复制到指定目录。例如 /moxa。然后执行以下命令。

       # cd /
       # mkdir moxa
       # cd /moxa
       # tar xvf /dev/fd0

       或者

       # cd /
       # mkdir moxa
       # cd /moxa
       # cp /mnt/cdrom/<驱动程序目录>/mxser.tgz.
       # tar xvfz mxser.tgz
``````
## 3.3 设备命名约定
```
       您可以在 /moxa/mxser 中找到所有的驱动程序和实用程序文件。以下的安装过程取决于您想要运行驱动程序的模型。如果您喜欢模块驱动程序，请参考 3.4 节。如果需要静态驱动程序，请参考 3.5 节。

       拨入和呼出端口
       -----------------------
       此驱动程序保留了传统的串行设备属性。每个串行端口有两个特殊文件名。一个是拨入端口，命名为“ttyMxx”。对于呼出端口，命名约定是“cumxx”。

       安装多个板卡时的设备命名
       -----------------------------------------------
       每个 Smartio/Industio 多端口板的命名约定预先定义如下。

       板卡编号  拨入端口  呼出端口
       第 1 块板  ttyM0 - ttyM7  cum0 - cum7
       第 2 块板  ttyM8 - ttyM15  cum8 - cum15
       第 3 块板  ttyM16 - ttyM23  cum16 - cum23
       第 4 块板  ttyM24 - ttym31  cum24 - cum31

      !!!!!!!!!!!!!!!!!!!! 注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
       在 Kernel 2.6 下，cum 设备已过时。因此请使用 ttyM* 设备代替。
      !!!!!!!!!!!!!!!!!!!! 注意!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

       板卡顺序
       --------------
       此驱动程序将根据驱动程序中设置的参数激活 ISA 板卡。在所有指定的 ISA 板卡激活后，PCI 板卡将自动安装到系统中。
       因此，板卡编号是根据 ISA 板卡的 CAP 地址排序的。对于 PCI 板卡，它们的顺序在 ISA 板卡之后，并且 C168H/PCI 比 C104H/PCI 板卡具有更高的优先级。
```
## 3.4 模块驱动程序配置
```
       模块驱动程序是最容易的安装方式。如果您喜欢静态驱动程序安装，请跳过此段落。

       ------------- 准备使用 MOXA 驱动程序 --------------------
       3.4.1 使用正确的主设备号创建 tty 设备
          在使用 MOXA 驱动程序之前，您的系统必须具有使用驱动程序的主设备号创建的 tty 设备。我们提供了一个 shell 脚本“msmknod”来简化此过程。
          此步骤仅需要执行一次。但是，在以下情况下，您仍然需要执行此过程：
          a. 您更改了驱动程序的主设备号。请参考“3.7”节。
          b. 您安装的 MOXA 板卡总数发生了变化。可能您添加/删除了一个 MOXA 板卡。
          c. 您想要更改 tty 名称。这需要修改 shell 脚本“msmknod”

          过程如下：
          # cd /moxa/mxser/driver
          #./msmknod

          此 shell 脚本将需要拨入设备和呼出设备的主设备号来创建 tty 设备。您还需要指定安装的 MOXA 板卡总数。拨入设备和呼出设备的默认主设备号是 30、35。如果您需要更改为其他号码，请参考“3.7”节以获取更详细的过程。
          Msmknod 将删除占用相同设备名称的任何特殊文件。

       3.4.2 构建 MOXA 驱动程序和实用程序
          在使用 MOXA 驱动程序和实用程序之前，您需要编译所有的源代码。此步骤仅需要执行一次。但是，如果您修改了源代码（例如，更改了驱动程序的主设备号（见“3.7”节）），则需要再次执行此步骤。

          在 /moxa/mxser 中找到“Makefile”，然后运行

          # make clean; make install

         !!!!!!!!!! 注意!!!!!!!!!!!!!!!!!
          对于 Red Hat 9、Red Hat Enterprise Linux AS3/ES3/WS3 和 Fedora Core1：
          # make clean; make installsp1

          对于 Red Hat Enterprise Linux AS4/ES4/WS4：
          # make clean; make installsp2
         !!!!!!!!!! 注意!!!!!!!!!!!!!!!!!

          驱动程序文件“mxser.o”和实用程序将被正确编译并分别复制到系统目录。

       ------------- 加载 MOXA 驱动程序 --------------------
       3.4.3 加载 MOXA 驱动程序

          # modprobe mxser <参数>

          将激活模块驱动程序。您可以运行“lsmod”检查“mxser”是否已激活。如果 MOXA 板是 ISA 板，则需要<参数>。请参考“3.4.5”节以获取更多信息。

       ------------- 在启动时加载 MOXA 驱动程序 --------------------
       3.4.4 对于上述描述，您可以手动执行“modprobe mxser”来激活此驱动程序，并运行“rmmod mxser”来删除它。
          然而，最好在启动时进行配置以避免手动操作。启动时的配置可以通过 rc 文件实现。我们在“moxa/mxser/driver”下提供了一个“rc.mxser”文件来简化此过程。

          但是，如果您使用 ISA 板，请修改“modprobe...”命令以添加参数（见“3.4.5”节）。修改 rc.mxser 后，请尝试手动执行“/moxa/mxser/driver/rc.mxser”以确保修改正确。如果遇到任何错误，请尝试再次修改。如果修改完成，请按照以下步骤操作。

          运行以下命令设置 rc 文件。

          # cd /moxa/mxser/driver
          # cp./rc.mxser /etc/rc.d
          # cd /etc/rc.d

          检查“rc.serial”是否存在。如果“rc.serial”不存在，请通过 vi 创建它，运行“chmod 755 rc.serial”更改权限。
          在最后一行添加“/etc/rc.d/rc.mxser”，

          重新启动并通过“lsmod”命令检查 moxa.o 是否已激活。

       3.4.5. 如果您想要在系统中驱动 Smartio/Industio ISA 板卡，在激活“mxser.o”时，您必须添加参数以指定给定板卡的 CAP 地址。参数的格式如下。

          modprobe mxser ioaddr=0x???,0x???,0x???,0x???
				|      |     |	  |
				|      |     |	  +- 第 4 个 ISA 板
				|      |     +------ 第 3 个 ISA 板
				|      +------------ 第 2 个 ISA 板
				+------------------- 第 1 个 ISA 板
```

## 3.5 适用于 Linux 内核 2.4.x 和 2.6.x 的静态驱动程序配置

**注意**：要使用静态驱动程序，您必须安装 Linux 内核源包。

3.5.1 内核中内置驱动程序的备份
```
# cd /usr/src/linux/drivers/char
# mv mxser.c mxser.c.old
对于 Red Hat 7.x 用户，您需要创建链接：
# cd /usr/src
# ln -s linux-2.4 linux
```

3.5.2 创建链接
```
# cd /usr/src/linux/drivers/char
# ln -s /moxa/mxser/driver/mxser.c mxser.c
```

3.5.3 为 ISA 板添加 CAP 地址列表。对于 PCI 板用户，请跳过此步骤。

在模块模式下，ISA 板的 CAP 地址由参数给定。在静态驱动程序配置中，您必须在驱动程序的源代码中进行分配。如果您不会安装任何 ISA 板，您可以跳到下一部分。修改驱动程序源代码的说明如下。

**步骤 a**
```
# cd /moxa/mxser/driver
# vi mxser.c
```

**步骤 b**
找到如下的数组 `mxserBoardCAP[]` 。

```
static int mxserBoardCAP[]
= {0x00, 0x00, 0x00, 0x00};
```

**步骤 c**
使用 `vi` 更改此数组中的地址。例如，要驱动 2 个具有 CAP 地址 0x280 和 0x180 的 ISA 板作为第一个和第二个板。只需将源代码更改如下。

```
static int mxserBoardCAP[]
= {0x280, 0x180, 0x00, 0x00};
```

**步骤 c**
使用 `vi` 更改此数组中的地址。例如，要驱动 2 个具有 CAP 地址 0x280 和 0x180 的 ISA 板作为第一个和第二个板。只需将源代码更改如下：

```
static int mxserBoardCAP[]
= {0x280, 0x180, 0x00, 0x00};
```

3.5.4 设置内核配置

配置内核：

```
# cd /usr/src/linux
# make menuconfig
```

您将进入一个菜单驱动的系统。请选择[字符设备][非标准串行端口支持]，使用“[*]”启用[Moxa SmartIO 支持]驱动程序（不是“[M]”），然后选择[退出]退出此程序。

3.5.5 重建内核

以下是用于 Linux 内核重建的内容，仅供您参考。

对于适当的详细信息，请参考 Linux 文档。

**步骤 a**
```
cd /usr/src/linux
```

**步骤 b**
```
make clean    /* 花费几分钟 */
```

**步骤 c**
```
make dep    /* 花费几分钟 */
```

**步骤 d**
```
make bzImage    /* 可能花费 10 - 20 分钟 */
```

**步骤 e**
```
make install    /* 将引导映像复制到正确的位置 */
```

**步骤 f**
请确保引导内核（vmlinuz）处于正确的位置。

**步骤 g**
如果您使用“lilo”实用程序，您应该检查 `/etc/lilo.conf` 中的“image”项指定的路径是否为“vmlinuz”路径，否则您将加载错误（或旧的）引导内核映像（vmlinuz）。检查 `/etc/lilo.conf` 后，请运行“lilo”。

请注意，如果“make bzImage”的结果是错误，那么您必须返回 Linux 配置设置。在 `/usr/src/linux` 目录中输入“make menuconfig”。

3.5.6 创建 tty 设备和特殊文件
```
# cd /moxa/mxser/driver
#./msmknod
```

3.5.7 创建实用程序
```
# cd /moxa/mxser/utility
# make clean; make install
```

3.5.8 重新启动

以下是排版成 Markdown 格式的内容：

# 3.6 自定义配置

虽然此驱动程序已经为您提供了默认配置，但您仍然可以更改设备名称和主编号。更改这些参数的说明如下。

更改设备名称

如果您想使用其他设备名称而不是默认命名约定，您所要做的就是修改 shell 脚本“msmknod”中的内部代码。首先，您必须通过 `vi` 打开“msmknod”。找到包含“ttyM”和“cum”的每一行，并将它们更改为您想要的设备名称。“msmknod”在下次执行时创建您需要的设备名称。

更改主编号

如果主编号 30 和 35 已被占用，您可能需要为该驱动程序选择 2 个空闲的主编号。更改主编号有 3 个步骤。

3.6.1 查找空闲的主编号

在 `/proc/devices` 中，您可以找到系统中占用的所有主编号。请选择 2 个可用的主编号。例如 40、45。

3.6.2 创建特殊文件

运行 `/moxa/mxser/driver/msmknod` 以使用指定的主编号创建特殊文件。

3.6.3 使用新的主编号修改驱动程序

运行 `vi` 打开 `/moxa/mxser/driver/mxser.c`。找到包含“MXSERMAJOR”的行。将内容更改如下。

```
#define    MXSERMAJOR    40
#define    MXSERCUMAJOR    45
```

3.6.4 在 `/moxa/mxser/driver` 中运行“make clean; make install”。

## 3.7 验证驱动程序安装

您可以参考 `/var/log/messages` 检查此驱动程序激活时报告的最新状态日志。
# 4. 实用工具
这个驱动程序包含 3 个实用程序。它们是 msdiag、msmon 和 msterm。这 3 个实用程序以源代码的形式发布。它们应该被编译成可执行文件并复制到 /usr/bin 中。
在使用这些实用程序之前，请加载驱动程序（参考 3.4 和 3.5）并确保你已经运行了“msmknod”实用程序。
- msdiag - 诊断
这个实用程序提供了显示驱动程序在系统中找到的 Moxa Smartio/Industio 板的功能。
- msmon - 端口监控
这个实用程序使用户能够快速查看所有 MOXA 端口的活动。当监控开始时，用户可以轻松了解每个端口的总接收/传输（Rx/Tx）字符数。每秒的 Rx/Tx 吞吐量也会按时间间隔（例如最后 5 秒）和平均基础（从监控开始时）报告。你可以通过<HOME>键重置所有端口的计数。<+> <->（加/减）键用于更改显示时间间隔。在端口上按<ENTER>，光标停留，以查看端口的通信参数、信号状态和输入/输出队列。
- msterm - 终端仿真
这个实用程序提供了所有 tty 端口的数据发送和接收能力，特别是对于 MOXA 端口。它对于测试简单应用程序非常有用，例如向连接到该端口的调制解调器发送 AT 命令或用作登录目的的终端。请注意，这只是一个哑终端仿真，不处理全屏操作。
# 5. Setserial
支持的 Setserial 参数如下列出。
- uart：设置 UART 类型（16450 --> 禁用 FIFO，16550A --> 启用 FIFO）
- close_delay：设置 DTR 在关闭时应保持低电平的时间量（以 1/100 秒为单位）。
- closing_wait：设置串行端口在关闭时应等待数据排空的时间量（以 1/100 秒为单位），然后再禁用接收器。
- spd_hi：当应用程序请求 38.4kb 时使用 57.6kb。
- spd_vhi：当应用程序请求 38.4kb 时使用 115.2kb。
- spd_shi：当应用程序请求 38.4kb 时使用 230.4kb。
- spd_warp：当应用程序请求 38.4kb 时使用 460.8kb。
- spd_normal：当应用程序请求 38.4kb 时使用 38.4kb。
- spd_cust：当应用程序请求 38.4kb 时使用自定义除数来设置速度。
- divisor：此选项设置自定义除法。
- baud_base：此选项设置基本波特率。
# 6.故障排除

在引导时，会尽可能清楚地说明错误消息和解决方案。如果所有可能的解决方案都失败，请联系我们的技术支持团队以获取更多帮助。

错误消息：找到超过 4 个 Moxa Smartio/Industio 系列板。第五个及以后的板将被忽略。

**解决方案**：
为避免此问题，请拔掉第五个及以后的板，因为 Moxa 驱动程序最多支持 4 个板。

错误消息：Request_irq 失败，IRQ（？）可能与另一个设备冲突。

**解决方案**：
其他 PCI 或 ISA 设备占用了分配的 IRQ。如果你不确定是哪个设备导致了这种情况，请检查/proc/interrupts 以找到空闲的 IRQ，并简单地为 Moxa 板更改另一个空闲的 IRQ。

错误消息：板#：C1xx 系列（CAP=xxx）中断号无效。

**解决方案**：
同一多端口板内的每个端口共享相同的 IRQ。请为一个 Moxa 板设置一个 IRQ（IRQ 不等于零）。

错误消息：未为 Moxa ISA 板（CAP=xxx）设置中断向量。

**解决方案**：
Moxa ISA 板需要一个中断向量。请参考用户手册“硬件安装”章节来设置中断向量。

错误消息：无法安装 MOXA Smartio/Industio 系列驱动程序！

**解决方案**：
加载 Moxa 驱动程序失败，主设备号可能与其他设备冲突。请参考前面的 3.7 节为 Moxa 驱动程序更改一个空闲的主设备号。

错误消息：无法安装 MOXA Smartio/Industio 系列呼叫驱动程序！

**解决方案**：
加载 Moxa 呼叫驱动程序失败，呼叫设备主设备号可能与其他设备冲突。请参考前面的 3.7 节为 Moxa 驱动程序更改一个空闲的呼叫设备主设备号。