# I2C/SMBus 中故障代码使用的最重要约定摘要

**“故障”并不总是“错误”**

并非所有故障报告都意味着错误；“页面错误”应该是一个熟悉的例子。软件经常在短暂故障后重试幂等操作。在某些情况下可能有更复杂的恢复方案，例如重新初始化（也许重置）。在这种由故障报告触发的恢复之后，没有错误。

同样，有时“故障”代码只是报告一个定义的操作结果……它根本不表示有任何错误，只是结果不在“黄金路径”上。

简而言之，您的 I2C 驱动程序代码可能需要知道这些代码才能正确响应。其他代码可能需要依赖您的代码报告正确的故障代码，以便它（反过来）能够正确运行。

**I2C 和 SMBus 故障代码**

这些在大多数调用中作为负数返回，零或某些正数表示无故障返回。这些符号关联的具体数字在不同架构之间有所不同，尽管大多数 Linux 系统使用 <asm-generic/errno*.h> 编号。

请注意，这里的描述并非详尽无遗。可能会返回其他代码，并且在其他情况下也应该返回这些代码。但是，驱动程序不应在这些情况下返回其他代码（除非硬件未提供唯一的故障报告）。

此外，适配器探测方法返回的代码遵循其主机总线（如 PCI 或平台总线）特定的规则。

`EAGAIN`
  由 I2C 适配器在主发送模式下失去仲裁时返回：其他主设备同时发送不同的数据。

  当在原子上下文中尝试调用 I2C 操作，而某些任务已经在使用该 I2C 总线执行其他操作时，也会返回。

`EBADMSG`
  当 SMBus 逻辑接收到无效的数据包错误代码字节时返回。此代码是涵盖事务中所有字节的 CRC，并在终止的 STOP 之前发送。此故障仅在读取事务中报告；SMBus 从设备可能有一种方法来报告主机写入时的 PEC 不匹配。请注意，即使使用了 PEC，您也不应仅依赖这些作为检测不正确数据传输的唯一方法。

`EBUSY`
  当 SMBus 总线繁忙时间超过允许的时间时，由 SMBus 适配器返回。这通常表示某些设备（可能是 SMBus 适配器）需要一些故障恢复（如重置），或者重置尝试但失败。

`EINVAL`
  这个相当模糊的错误意味着在任何 I/O 操作开始之前检测到无效的参数。在可能的情况下使用更具体的故障代码。

`EIO`
  这个相当模糊的错误意味着在执行 I/O 操作时出现了问题。在可能的情况下使用更具体的故障代码。

`ENODEV`
  由驱动程序的 `probe()` 方法返回。这比 `ENXIO` 更具体，意味着问题不在于地址，而在于在那里找到的设备。驱动程序探测可能会验证设备返回 *正确* 的响应，并在适当时返回此代码。（驱动程序核心将警告除 `ENXIO` 和 `ENODEV` 之外的探测故障。）

`ENOMEM`
  由任何在需要时无法分配内存的组件返回。

`ENXIO`
  由 I2C 适配器返回，以指示传输的地址阶段未获得 ACK。虽然这可能只是意味着 I2C 设备暂时未响应，但通常意味着该地址没有任何监听。

  由驱动程序的 `probe()` 方法返回，以指示它们未找到要绑定的设备。（也可能使用 `ENODEV`。）

`EOPNOTSUPP`
  当要求适配器执行它不支持或无法支持的操作时，由适配器返回。

  例如，当要求不支持 SMBus 块传输的适配器执行一个时，将返回此代码。在这种情况下，发出该块传输请求的驱动程序应该在发出请求之前验证该功能是否受支持。

  同样，如果 I2C 适配器无法执行所有合法的 I2C 消息，当被要求执行它无法执行的事务时，应返回此代码。（这些限制在适配器的功能掩码中不可见，因为假设如果适配器支持 I2C，它支持所有的 I2C。）

`EPROTO`
  当从设备不符合相关的 I2C 或 SMBus（或特定芯片）协议规范时返回。一种情况是 SMBus 块数据响应（来自 SMBus 从设备）的长度超出 1 - 32 字节的范围。

`ETIMEDOUT`
  当驱动程序操作花费太多时间，并在完成之前被中止时，由驱动程序返回。

  当操作花费的时间超过 SMBus 规范允许的时间时，SMBus 适配器可能会返回；例如，当从设备拉伸时钟太远时。I2C 没有这样的超时，但 I2C 适配器施加一些任意限制（比 SMBus 长得多！）是正常的。