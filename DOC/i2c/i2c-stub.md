# 模块：`i2c-stub`

**描述**：

此模块是一个非常简单的假 I2C/SMBus 驱动程序。它实现了六种类型的 SMBus 命令：快速写入、（读/写）字节、（读/写）字节数据、（读/写）字数据、（读/写）I2C 块数据和（读/写）SMBus 块数据。

在加载此驱动程序时，您需要提供芯片地址作为模块参数，然后它将仅对这些地址的 SMBus 命令作出反应。

此模块不需要硬件也不与任何硬件相关。它将接受对指定地址的快速写入命令；对于其他命令（同样针对指定地址），它将通过从内存中的数组读取或写入来响应。它还会为处理的每个命令向内核日志发送大量信息。

对于所有字节操作，都实现了一个带自动递增的指针寄存器。这允许像 EEPROM 等支持的连续字节读取。

SMBus 块命令支持默认是禁用的，必须通过在功能模块参数中明确设置相应的位（0x03000000）来启用。

SMBus 块命令必须写入以配置用于 SMBus 块操作的 SMBus 命令。写入可以是部分的。块读取命令总是返回迄今为止最大写入所选择的字节数。

典型的用例如下：
1. 加载此模块
2. 使用 `i2cset`（来自 `i2c-tools` 项目）预加载一些数据
3. 加载目标芯片驱动模块
4. 在内核日志中观察其行为

在 `i2c-tools` 包中有一个名为 `i2c-stub-from-dump` 的脚本，它可以从芯片转储自动加载寄存器值。

**参数**：

`int chip_addr[10]`：
  要模拟芯片的 SMBus 地址。

`unsigned long functionality`：
  功能覆盖，用于禁用某些命令。有关合适的值，请参阅 `<linux/i2c.h>` 中的 `I2C_FUNC_*` 常量。例如，值 `0x1f0000` 仅启用快速、字节和字节数据命令。

`u8 bank_reg[10]`
`u8 bank_mask[10]`
`u8 bank_start[10]`
`u8 bank_end[10]`：
  可选的存储体设置。它们告知哪个寄存器中的哪些位选择活动存储体，以及存储体寄存器的范围。

**注意事项**：

如果您的目标驱动程序轮询某些字节或字并等待其更改，此存根可能会使其锁定。使用 `i2cset` 解锁。

如果您发送的信息过多，`printk` 可能会有丢失。此模块确实需要类似 `relayfs` 的东西。