# 25 gdb 文本用户界面

gdb 文本用户界面（TUI）是一个终端界面，它使用`curses`库在单独的文本窗口中显示源文件、汇编输出、程序寄存器和 gdb 命令。TUI 模式仅在有合适版本的`curses`库可用的平台上受支持。

当你以“gdb -tui”调用 gdb 时，默认启用 TUI 模式。在 gdb 运行时，你还可以通过使用各种 TUI 命令和键绑定（例如`tui enable`或 C-x C-a）在 TUI 模式之间切换。请参阅第 25.5 节[TUI 命令]，第 584 页，以及第 25.2 节[TUI 键绑定]，第 582 页。

## 25.1 TUI 概述

在 TUI 模式下，gdb 可以显示多个文本窗口：

```
command 此窗口是带有 gdb 提示符和 gdb 输出的 gdb 命令窗口。gdb 输入仍使用 readline 进行管理。
source 源窗口显示程序的源文件。当前行和活动断点在该窗口中显示。
assembly 汇编窗口显示程序的反汇编输出。
register 此窗口显示处理器寄存器。当寄存器的值发生变化时，它们会被突出显示。
```

源和汇编窗口通过突出显示当前行并以“>”标记标记它来显示当前程序位置。默认情况下，对于突出显示的文本，禁用源和汇编代码样式，但可以使用“set style tui-current-position on”命令启用它。请参阅第 22.5 节[输出样式]，第 371 页。

断点用两个标记表示。第一个标记表示断点类型：

```
B 至少命中一次的断点。
b 从未命中的断点。
H 至少命中一次的硬件断点。
h 从未命中的硬件断点。
```

第二个标记表示断点是否启用：

```
+ 断点已启用。
- 断点已禁用。
```

当当前线程更改、帧更改或程序计数器更改时，源、汇编和寄存器窗口会更新。

这些窗口不能同时全部可见。命令窗口始终可见。其他窗口可以以几种布局排列：

```
• 仅源，
• 仅汇编，
• 源和汇编，
• 源和寄存器，或
• 汇编和寄存器。
```

这些是标准布局，但可以定义其他布局。

命令窗口上方的状态行显示以下信息：

```
target 		指示当前的 gdb 目标。（请参阅第 19 章[指定调试目标]，第 311 页）。
process 	给出当前的进程或线程编号。当没有正在调试的进程时，此字段设置为“无进程”。
focus 		显示具有焦点的 TUI 窗口的名称。
function 	给出所选帧的当前函数名称。如果启用了解装饰（请参阅第 10.9 节[打印设置]，第 157 页），则名称将被解装饰。当没有与当前程序计数器对应的符号时，将显示字符串“??”。
line 		指示所选帧的当前行号。当不知道当前行号时，将显示字符串“??”。
pc 			指示当前程序计数器地址。
```

## 25.2 TUI 键绑定

TUI 在 readline 键映射中安装了几个键绑定（见第 33 章[命令行编辑]，第 715 页）。以下键绑定在 TUI 模式和 gdb 标准模式下都已安装。

```
C-x C-a
C-x a
C-x A  
	进入或离开 TUI 模式。离开 TUI 模式时，curses 窗口管理停止，gdb 使用其标准模式直接在终端上进行操作。重新进入 TUI 模式时，控制权交回给 curses 窗口。然后屏幕将被刷新。
	此键绑定使用可绑定的 Readline 函数`tui-switch-mode`。

C-x 1 
	使用只有一个窗口的 TUI 布局。布局将是“源”或“汇编”。当 TUI 模式不活动时，它将切换到 TUI 模式。将此键绑定视为 Emacs 的 C-x 1 绑定。
	此键绑定使用可绑定的 Readline 函数`tui-delete-other-windows`。

C-x 2 
	使用至少有两个窗口的 TUI 布局。当当前布局已经有两个窗口时，使用下一个有两个窗口的布局。选择新布局时，一个窗口将始终是前一个布局和新布局共有的。
	将其视为 Emacs 的 C-x 2 绑定。
	此键绑定使用可绑定的 Readline 函数`tui-change-windows`。

C-x o 
	更改活动窗口。TUI 将几个键绑定（如滚动和箭头键）与活动窗口相关联。此命令将焦点赋予下一个 TUI 窗口。
	将其视为 Emacs 的 C-x o 绑定。
	此键绑定使用可绑定的 Readline 函数`tui-other-window`。

C-x s 
	在 TUI 单键模式和 TUI 标准模式之间切换，该模式将单个键绑定到 gdb 命令（见第 25.3 节[TUI 单键模式]，第 583 页）。
	此键绑定使用可绑定的 Readline 函数`next-keymap`。
```
	
以下键绑定仅在 TUI 模式下有效：

```
PgUp 	向上滚动活动窗口一页。
PgDn 	向下滚动活动窗口一页。
Up 		向上滚动活动窗口一行。
Down 	向下滚动活动窗口一行。
Left 	向左滚动活动窗口一列。
Right 	向右滚动活动窗口一列。
C-L 	刷新屏幕。
```

因为在 TUI 模式下箭头键会滚动活动窗口，所以除非命令窗口具有焦点，否则它们不能用于 readline 的正常用途。当另一个窗口处于活动状态时，您必须使用其他 readline 键绑定，如 C-p、C-n、C-b 和 C-f 来控制命令窗口。

## 25.3 TUI 单键模式

TUI 还提供了单键模式，它将几个常用的 gdb 命令绑定到单个键上。输入 C-x s 切换到这个模式，在此模式下使用以下键绑定：

```
c 继续
C 逆向继续
d 向下
f 完成
F 逆向完成
n 下一步
N 逆向下一步
o 下一步（“step Over”的缩写）。
O 逆向下一步
q 退出单键模式。
r 运行
s 单步执行
S 逆向单步执行
i 单步进入（“step Into”的缩写）。
I 逆向单步进入
u 向上
v 显示局部变量信息
w 查看当前位置
```

其他键暂时切换到 gdb 命令提示符。按下的键将插入到编辑缓冲区中，这样就可以在不与 TUI 单键模式交互的情况下输入大多数 gdb 命令。一旦输入命令，TUI 单键模式将恢复。永久离开此模式的唯一方法是输入 q 或 C-x s。

如果 gdb 是使用 Readline 8.0 或更高版本构建的，TUI 单键映射将被命名为“SingleKey”。这可以在.inputrc 文件中用于向此映射添加额外的绑定。

## 25.4 TUI 鼠标支持

如果 `curses` 库支持鼠标，TUI 就支持鼠标操作。

鼠标滚轮会在鼠标光标下的相应窗口中滚动。

TUI 本身并不直接支持用鼠标进行复制/粘贴。然而，在 Unix 终端上，通常可以按下并按住键盘上的 `SHIFT` 键，暂时绕过 `gdb` 的 TUI 并访问终端的原生鼠标复制/粘贴功能（通常，点击 - 拖动 - 释放或双击来选择文本，中键点击来粘贴）。这种复制/粘贴是与终端的选择缓冲区一起工作的，而不是与 TUI 的缓冲区一起。或者，要完全在 TUI 中禁用鼠标支持并让终端控制鼠标点击，可以关闭 `tui mouse-events` 设置（见 [设置 tui mouse-events]，第 588 页）。

Python 扩展可以对鼠标点击做出反应（见 [Window.click]，第 502 页）。

## 25.5 TUI 特定命令

TUI 具有控制文本窗口的特定命令。这些命令始终可用，即使 gdb 不在 TUI 模式下也是如此。当 gdb 处于标准模式时，这些命令中的大多数将自动切换到 TUI 模式。

请注意，如果 gdb 的标准输出未连接到终端，或者 gdb 是使用机器接口解释器启动的（参见第 27 章 [gdb/mi 接口]，第 591 页），这些命令中的大多数将因错误而失败，因为启用 curses 窗口管理可能不可行或不希望这样做。

```
`tui enable`
	激活 TUI 模式。如果在当前调试会话中之前已使用过 TUI 模式，则将使用最后一个活动的 TUI 窗口布局，否则将使用默认布局。

`tui disable`
	禁用 TUI 模式，返回到控制台解释器。

`info win`
	列出所有当前显示窗口的名称和大小。

`tui new-layout name window weight [window weight...]`
	创建一个新的 TUI 布局。新布局将被命名为`name`，可以使用`layout`命令（见下文）进行访问。
	每个窗口参数要么是要显示的窗口的名称，要么是一个窗口描述。窗口将按照列出的顺序从上到下显示。
	窗口的名称与`focus`命令（见下文）给出的名称相同；此外，还可以指定状态窗口。请注意，由于其高度固定，分配给状态窗口的权重并不重要。通常在这里使用“0”。
	窗口描述看起来有点像`tui new-layout`的调用，形式为`{[-horizontal]window weight [window weight...]}`。
	这指定了一个子布局。如果给出了`-horizontal`，则此描述中的窗口将并排排列，而不是从上到下排列。
	每个权重都是一个整数。它是此窗口相对于布局中所有其他窗口的权重。这些数字用于计算每个窗口在屏幕上所占的比例。
	例如：
		(gdb) tui new-layout example src 1 regs 1 status 0 cmd 1
	
	在此，新布局称为“example”。它显示源和寄存器窗口，后跟状态窗口，最后是命令窗口。非状态窗口的权重相同，因此终端将被分成大致相等的三个部分。
	以下是一个更复杂的示例，显示水平布局：
		(gdb) tui new-layout example {-horizontal src 1 asm 1} 2 status 0 cmd 1
	
	这将导致并排的源和汇编窗口；状态和命令窗口位于这些窗口下方，填充终端的整个宽度。由于它们的权重为 2，源和汇编窗口的高度将是命令窗口的两倍。

`tui layout name`
`layout name`
	更改显示的 TUI 窗口。`name`参数控制显示哪个布局。它可以是内置布局名称之一，也可以是用户使用`tui new-layout`定义的布局的名称。
	内置布局如下：
		`next` 	显示下一个布局。
		`prev` 	显示上一个布局。
		`src` 	显示源和命令窗口。
		`asm` 	显示汇编和命令窗口。
		`split` 显示源、汇编和命令窗口。
		`regs` 	在`src`布局中显示寄存器、源和命令窗口。在`asm`或`split`布局中显示寄存器、汇编器和命令窗口。

`tui focus name`
`focus name`
	更改当前活动用于滚动的 TUI 窗口。`name`参数可以是以下任何一个：
		`next` 	使下一个窗口成为活动滚动窗口。
		`prev` 	使上一个窗口成为活动滚动窗口。
		`src` 	使源窗口成为活动滚动窗口。
		`asm` 	使汇编窗口成为活动滚动窗口。
		`regs` 	使寄存器窗口成为活动滚动窗口。
		`cmd` 	使命令窗口成为活动滚动窗口。

`tui refresh`
`refresh`
	刷新屏幕。这类似于输入 C-L。

`tui reg group`
	更改在 TUI 寄存器窗口中显示的寄存器组为`group`。如果当前未显示寄存器窗口，此命令将导致显示寄存器窗口。寄存器组的列表及其顺序是目标特定的。在大多数目标上可用的以下组：
		`next` 		反复选择此组将导致显示循环通过所有可用的寄存器组。
		`prev` 		反复选择此组将导致显示循环通过所有可用的寄存器组，顺序与`next`相反。
		`general` 	显示通用寄存器。
		`float` 	显示浮点寄存器。
		`system` 	显示系统寄存器。
		`vector` 	显示向量寄存器。
		`all` 		显示所有寄存器。

`update`
	更新源窗口和当前执行点。

`tui window height name +count`
`tui window height name -count`
`winheight name +count`
`winheight name -count`
	将窗口`name`的高度更改`count`行。正计数增加高度，负计数减小高度。`name`参数可以是任何当前可见窗口的名称。可以使用`info win`（见 [info win]，第 584 页）发现当前可见窗口的名称。
	当前可见窗口的集合必须始终填满终端，因此，只有在有其他可见窗口可以提供或接收额外终端空间的情况下，才可以调整一个窗口的大小。

`tui window width name +count`
`tui window width name -count`
`winwidth name +count`
`winwidth name -count`
	将窗口`name`的宽度更改`count`列。正计数增加宽度，负计数减小宽度。`name`参数可以是任何当前可见窗口的名称。可以使用`info win`（见 [info win]，第 584 页）发现当前可见窗口的名称。
	当前可见窗口的集合必须始终填满终端，因此，只有在有其他可见窗口可以提供或接收额外终端空间的情况下，才可以调整一个窗口的大小。
```

## 25.6 TUI 配置变量

有几个配置变量控制 TUI 窗口的外观。

```
set tui border-kind kind
	为源、汇编和寄存器窗口选择边框外观。
	可能的值如下：
		space 	使用空格字符绘制边框。
		ascii 	使用 ASCII 字符‘+’、‘-’和‘|’绘制边框。
		acs 	使用备用字符集绘制边框。如果终端支持，边框将使用字符行图形绘制。

set tui border-mode mode
set tui active-border-mode mode
	为非活动窗口或活动窗口的边框选择显示属性。模式可以是以下之一：
		normal 			使用普通属性显示边框。
		standout 		使用突出显示模式。
		reverse 		使用反转视频模式。
		half 			使用半亮模式。
		half-standout	使用半亮和突出显示模式。
		bold 			使用额外亮或粗体模式。
		bold-standout	使用额外亮或粗体和突出显示模式。

set tui tab-width nchars
	将制表位的宽度设置为 nchars 字符。此设置影响源和汇编窗口中 TAB 字符的显示。

set tui compact-source [on|off]
	设置 TUI 源窗口是否以“紧凑”形式显示。默认显示为行号使用更多空间；紧凑显示仅使用当前文件中行号所需的空间。

set tui mouse-events [on|off]
	打开时（默认），鼠标点击控制 TUI（见第 25.4 节[TUI 鼠标支持]，第 584 页）。关闭时，鼠标点击由终端处理，启用终端原生文本选择。

set debug tui [on|off]
	打开或关闭与 TUI 相关的 gdb 内部调试消息的显示。

show debug tui
	显示与 TUI 相关的 gdb 内部调试消息的当前显示状态。
```

请注意，可以使用适当的 set style 命令控制 TUI 边框的颜色。见第 22.5 节[输出样式]，第 371 页。