# 进入和退出 gdb

本章讨论如何启动 gdb 以及如何退出。要点如下：
- 输入 `gdb` 启动 gdb 。
- 输入 `quit` 、 `exit` 或 `Ctrl-d` 退出。

## 2.1 调用 gdb
通过运行 `gdb` 程序来调用 gdb 。一旦启动，gdb 会从终端读取命令，直到您指示其退出。

您还可以使用各种参数和选项来运行 gdb ，以便在一开始就指定更多调试环境。

这里描述的命令行选项旨在涵盖各种情况；在某些环境中，其中一些选项可能实际上不可用。

启动 gdb 最常见的方式是使用一个参数，指定一个可执行程序：
```
gdb program
```
您也可以同时指定一个可执行程序和一个核心文件来启动：
```
gdb program core
```
或者，您可以将进程 ID 作为第二个参数指定，或者使用 `-p` 选项，如果您要调试一个正在运行的进程：
```
gdb program 1234
gdb -p 1234
```
这将使 gdb 附加到进程 1234 。使用 `-p` 选项时，您可以省略程序文件名。

利用第二个命令行参数需要一个相当完整的操作系统；当您将 gdb 用作连接到裸板的远程调试器时，可能没有“进程”的概念，并且通常也无法获取核心转储。如果 gdb 无法附加或读取核心转储，它会发出警告。

您可以选择让 gdb 将可执行文件后面的任何参数传递给下级，使用 `--args` 。此选项停止选项处理。
```
gdb --args gcc -O2 -c foo.c
```
这将导致 gdb 调试 `gcc` ，并将 `gcc` 的命令行参数（见第 4.3 节[参数]，第 38 页）设置为 `-O2 -c foo.c` 。

您可以在不打印介绍材料（描述 gdb 的非保修）的情况下运行 gdb ，通过指定 `--silent` （或 `-q/--quiet` ）：
```
gdb --silent
```
您还可以使用命令行选项进一步控制 gdb 的启动方式。gdb 本身可以提醒您可用的选项。

输入
```
gdb -help
```
以显示所有可用选项并简要描述其用途（`gdb -h` 是较短的等效方式）。

所有提供的选项和命令行参数都按顺序处理。当使用 `-x` 选项时，顺序会产生影响。

### 2.1.1 选择文件
当 gdb 启动时，它将除选项之外的任何参数视为指定可执行文件和核心文件（或进程 ID ）。这与分别使用 `-se` 和 `-c` （或 `-p` ）选项指定的情况相同。（gdb 将第一个没有关联选项标志的参数视为等效于 `-se` 选项后跟该参数；如果有第二个没有关联选项标志的参数，则将其视为等效于 `-c` / `-p` 选项后跟该参数。）如果第二个参数以十进制数字开头，gdb 将首先尝试将其作为进程附加，如果失败，则尝试将其作为核心文件打开。如果您有一个以数字开头的核心文件名称，可以通过在其前面添加 `./` 来防止 gdb 将其视为 pid ，例如 `./12345` 。

如果 gdb 未配置为包含核心文件支持（例如对于大多数嵌入式目标），则它将对第二个参数发出抱怨并忽略它。

对于 `-s` 、 `-e` 和 `-se` 选项及其长形式等效项，用于在文件系统中搜索符号和/或可执行文件的方法与 `file` 命令使用的方法相同。见第 18.1 节[file]，第 291 页。

许多选项都有长形式和短形式；以下列表中都有显示。只要选项足够明确，gdb 也会识别截断的长形式。（如果您愿意，可以使用 `--` 而不是 `-` 来标记选项参数，尽管我们说明了更常见的约定。）

`-symbols file`
`-s file` 从文件 `file` 读取符号表。

`-exec file`
`-e file` 将文件 `file` 用作在适当情况下要执行的可执行文件，并与核心转储一起检查纯数据。

`-se file` 从文件 `file` 读取符号表，并将其用作可执行文件。

`-core file`
`-c file` 将文件 `file` 用作要检查的核心转储。

`-pid number`
`-p number` 连接到进程 ID 为 `number` 的进程，如同使用 `attach` 命令。

`-command file`
`-x file` 从文件 `file` 执行命令。此文件的内容将与 `source` 命令的评估方式完全相同。见第 23.1.3 节[命令文件]，第 395 页。

`-eval-command command`
`-ex command` 执行单个 gdb 命令。

此选项可以多次使用以调用多个命令。也可以根据需要与 `-command` 交错使用。

```
gdb -ex ’target sim’ -ex ’load’ \
-x setbreakpoints -ex ’run’ a.out
```

`-init-command file`
`-ix file` 在加载下级之前（但在加载 gdbinit 文件之后）从文件 `file` 执行命令。见第 2.1.3 节[启动]，第 16 页。

`-init-eval-command command`
`-iex command` 在加载下级之前（但在加载 gdbinit 文件之后）执行单个 gdb 命令。见第 2.1.3 节[启动]，第 16 页。

`-early-init-command file`
`-eix file` 在初始化过程的早期从文件执行命令，在任何输出产生之前。见第 2.1.3 节[启动]，第 16 页。

`-early-init-eval-command command`
`-eiex command` 在初始化过程的早期执行单个 gdb 命令，在任何输出产生之前。

`-directory directory`
`-d directory` 将 `directory` 添加到搜索源和脚本文件的路径中。

`-r`
`-readnow` 立即读取每个符号文件的整个符号表，而不是默认的在需要时逐步读取。这会使启动变慢，但使未来的操作更快。

`--readnever` 不读取每个符号文件的符号调试信息。这会使启动更快，但代价是无法进行符号调试。DWARF 展开信息也不会读取，这意味着回溯可能变得不完整或不准确。其中一种用途是当用户只是想执行以下序列时：附加，转储核心，分离。在这种情况下，加载调试信息是不必要的延迟原因。

### 2.1.2 选择模式
您可以在各种替代模式下运行 gdb ，例如批处理模式或安静模式。

`-nx`
`-n` 不执行在任何初始化文件中找到的命令（见第 2.1.4 节[初始化文件]，第 17 页）。

`-nh` 不执行在任何主目录初始化文件中找到的命令（见第 2.1.4 节[主目录初始化文件]，第 17 页）。系统范围和当前目录的初始化文件仍然会加载。

`-quiet`
`-silent`
`-q` “安静”。不打印介绍性和版权消息。这些消息在批处理模式中也会被抑制。

这也可以通过使用 `set startup-quietly on` 来启用。默认是关闭的。使用 `show startup-quietly` 查看当前设置。将 `set startup-quietly on` 放入您的早期初始化文件（见第 2.1.4 节[初始化文件]，第 17 页）中，以使未来的 gdb 会话安静启动。

`-batch` 以批处理模式运行。处理完所有使用 `-x` 指定的命令文件（以及所有初始化文件中的命令，如果未被 `-n` 抑制）后，以状态 0 退出。如果在执行命令文件中的 gdb 命令时发生错误，则以非零状态退出。批处理模式还禁用分页，设置无限的终端宽度和高度（见第 22.4 节[屏幕大小]，第 370 页），并且表现得好像 `set confirm off` 生效（见第 22.9 节[消息/警告]，第 381 页）。

批处理模式可能对于将 gdb 用作过滤器很有用，例如在另一台计算机上下载并运行程序；为了使其更有用，当在 gdb 控制下运行的程序终止时，通常发出的消息“Program exited normally.”（程序正常退出）在批处理模式下不会发出。

`-batch-silent` 以与 `-batch` 完全相同的批处理模式运行，但完全静默。阻止所有 gdb 输出到标准输出（标准错误不受影响）。这比 `-silent` 安静得多，对于交互式会话毫无用处。

当使用例如给出“Loading section”消息的目标时，这特别有用。

请注意，通过 gdb 输出的目标，而不是直接写入标准输出的目标，也将被静默。

`-return-child-result`
gdb 的返回代码将是子进程（正在调试的进程）的返回代码，但有以下例外：
- gdb 异常退出。例如，由于不正确的参数或内部错误。在这种情况下，退出代码与没有 `-return-child-result` 时相同。
- 用户使用明确的值退出。例如，`quit 1` 。
- 子进程从未运行，或不允许终止，在这种情况下，退出代码将为 `-1` 。

当 gdb 用作远程程序加载器或模拟器接口时，与 `-batch` 或 `-batch-silent` 结合使用此选项很有用。

`-nowindows`
`-nw` “无窗口”。如果 gdb 内置了图形用户界面（GUI），则此选项告诉 gdb 仅使用命令行界面。如果没有 GUI 可用，此选项无效。

`-windows`
`-w` 如果 gdb 包含 GUI ，则此选项要求在可能的情况下使用它。

`-cd directory`
使用 `directory` 作为工作目录运行 gdb ，而不是当前目录。

`-data-directory directory`
`-D directory` 使用 `directory` 作为数据目录运行 gdb 。数据目录是 gdb 搜索其辅助文件的位置。见第 18.8 节[数据文件]，第 308 页。

`-fullname`
`-f` gnu Emacs 在将 gdb 作为子进程运行时设置此选项。它告诉 gdb 在每次显示堆栈帧时（包括每次程序停止时）以标准、可识别的方式输出完整的文件名和行号（包括每次程序停止时）。这种可识别的格式看起来像两个 `\032` 字符，后跟文件名、行号和字符位置，用冒号分隔，并带有换行符。Emacs 到 gdb 的接口程序使用这两个 `\032` 字符作为显示帧的源代码的信号。

`-annotate level`
此选项设置 gdb 内部的注释级别。其效果与使用 `set annotate level` 相同（见第 28 章[注释]，第 697 页）。注释级别控制 gdb 与提示符一起打印的信息量、表达式的值、源代码行和其他类型的输出。级别 0 是正常的，级别 1 用于当 gdb 作为 gnu Emacs 的子进程运行时，级别 3 是适用于控制 gdb 的程序的最大注释，级别 2 已被弃用。

注释机制在很大程度上已被 gdb/mi （见第 27 章[GDB/MI]，第 591 页）取代。

`--args` 更改命令行的解释，以便可执行文件后面的参数作为命令行参数传递给下级。此选项停止选项处理。

`-baud bps`
`-b bps` 设置 gdb 用于远程调试的任何串行接口的线路速度（波特率或每秒位数）。

`-l timeout` 设置 gdb 用于远程调试的任何通信的超时（以秒为单位）。

`-tty device`
`-t device` 使用 `device` 作为程序的标准输入和输出运行。

`-tui` 启动时激活文本用户界面。文本用户界面在终端上管理多个文本窗口，显示源代码、汇编、寄存器和 gdb 命令输出（见第 25 章[gdb 文本用户界面]，第 581 页）。如果从 Emacs 运行 gdb ，则不要使用此选项（见第 26 章[在 gnu Emacs 下使用 gdb]，第 589 页）。

`-interpreter interp` 使用解释器 `interp` 与控制程序或设备进行接口。此选项旨在由使用 gdb 作为后端进行通信的程序设置。见第 24 章[命令解释器]，第 579 页。

`--interpreter=mi` （或 `--interpreter=mi3` ）导致 gdb 使用自 gdb 版本 9.1 以来包含的 gdb/mi 接口版本 3 （见第 27 章[gdb/mi 接口]，第 591 页）。gdb 6.0 中包含的 gdb/mi 版本 2 （mi2）和 gdb 5.3 中包含的版本 1 （mi1）也可用。不再支持早期的 gdb/mi 接口。

`-write` 打开可执行文件和核心文件以供读写。这等效于 gdb 内部的 `set write on` 命令（见第 17.6 节[修补]，第 285 页）。

`-statistics` 此选项使 gdb 在完成每个命令并返回提示符后打印有关时间和内存使用情况的统计信息。

`-version` 此选项使 gdb 打印其版本号和无保修声明，然后退出。

`-configuration` 此选项使 gdb 打印有关其构建时配置参数的详细信息，然后退出。在报告 gdb 错误时，这些详细信息可能很重要（见第 32 章[GDB 错误]，第 711 页）。

### 2.1.3 gdb 启动期间的操作

以下是 gdb 在会话启动期间的操作描述：

1. 执行初始化基本内部状态所需的最小设置。
2. 从您的主目录中的早期初始化文件（如果有）读取命令。只有受限的一组命令可以放入早期初始化文件中，有关详细信息，请参阅第 2.1.4 节[初始化文件]，第 17 页。
3. 按照指定的顺序执行由 `-eiex` 和 `-eix` 命令行选项指定的命令和命令文件。只有受限的一组命令可以与 `-eiex` 和 `eix` 一起使用，有关详细信息，请参阅第 2.1.4 节[初始化文件]，第 17 页。
4. 根据命令行设置命令解释器（见第 2.1.2 节[模式选项]，第 13 页）。
5. 读取系统范围的初始化文件和系统范围初始化目录中的文件，请参阅[系统范围的初始化文件]，第 18 页。
6. 读取您的主目录中的初始化文件（如果有）并执行该文件中的所有命令，请参阅[主目录初始化文件]，第 18 页。
7. 按照指定的顺序执行由 `-iex` 和 `-ix` 选项指定的命令和命令文件。通常您应该使用 `-ex` 和 `-x` 选项，但通过这种方式，您可以在 gdb 初始化文件执行之前和下级加载之前应用设置。
8. 处理命令行选项和操作数。
9. 只要 `set auto-load local-gdbinit` 设置为 `on` （见第 22.8.1 节[当前目录中的初始化文件]，第 378 页），就从当前工作目录读取并执行初始化文件（如果有）中的命令。只有当前目录与您的主目录不同时才会这样做。因此，您可以有多个初始化文件，一个在您的主目录中通用，另一个在您调用 gdb 的目录中特定于您正在调试的程序。请参阅[启动期间的当前目录初始化文件]，第 19 页。
10. 如果命令行指定了要调试的程序、要附加的进程或核心文件，gdb 会加载为该程序或其加载的共享库提供的任何自动加载脚本。见第 22.8 节[自动加载]，第 376 页。

如果您希望在启动期间禁用自动加载，必须执行以下操作：

```
$ gdb -iex "set auto-load python-scripts off" myprogram
```

选项 `-ex` 不起作用，因为此时自动加载已太晚关闭。

11. 按照指定的顺序执行由 `-ex` 和 `-x` 选项指定的命令和命令文件。有关 gdb 命令文件的更多详细信息，请参阅第 23.1.3 节[命令文件]，第 395 页。
12. 读取在历史文件中记录的命令历史。有关命令历史和 gdb 记录它的文件的更多详细信息，请参阅第 22.3 节[命令历史]，第 368 页。

### 2.1.4 初始化文件

在启动期间（见第 2.1.3 节[启动]，第 16 页），gdb 将从几个初始化文件中执行命令。这些初始化文件使用与命令文件相同的语法（见第 23.1.3 节[命令文件]，第 395 页），并且 gdb 以相同的方式处理它们。

要显示 gdb 在启动时加载的初始化文件列表及其加载顺序，您可以使用 `gdb --help` 。

早期初始化文件在 gdb 的初始化过程早期加载，在解释器（见第 24 章[解释器]，第 579 页）初始化之前，以及在默认目标（见第 19 章[目标]，第 311 页）初始化之前。只有 `set` 或 `source` 命令应该放入早期初始化文件中，并且可以使用的唯一 `set` 命令是那些控制 gdb 启动方式的命令。

可以放入早期初始化文件中的命令将在本手册中作为这样的命令进行记录。任何未记录为适合早期初始化文件的命令都应放入常规初始化文件中。传递给 `--early-init-command` 或 `-eix` 的命令文件也是早期初始化文件，具有相同的命令限制。只有可以出现在早期初始化文件中的命令才应传递给 `--early-init-eval-command` 或 `-eiex` 。

相比之下，常规初始化文件在稍后处理，在 gdb 完成自身内部初始化过程之后，任何有效的命令都可以在这些文件中使用。

在本手册的其余部分，术语“初始化文件”指的是常规初始化文件之一，而不是早期初始化文件。任何关于早期初始化文件的讨论都将特别提及正在讨论的是早期初始化文件。

由于系统范围和主目录的初始化文件在处理大多数命令行选项之前被处理，因此对设置（例如 `set complaints` ）的更改可能会影响后续的命令行选项和操作数的处理。

以下各节描述了 gdb 查找早期初始化文件和初始化文件的位置，以及文件的搜索顺序。

#### 2.1.4.1 主目录早期初始化文件

gdb 最初在用户主目录中查找早期初始化文件 1 。有多个位置可供 gdb 在主目录中搜索，这些位置按顺序搜索，gdb 将加载它找到的第一个文件，并且不会检查后续位置。

在非 macOS 主机上搜索的位置是：
- 如果定义了环境变量 `XDG_CONFIG_HOME` ，则在其指向的目录中的 `gdb/gdbearlyinit` 文件。
- 如果定义了环境变量 `HOME` ，则在其指向的目录中的 `.config/gdb/gdbearlyinit` 文件。
- 如果定义了环境变量 `HOME` ，则在其指向的目录中的 `.gdbearlyinit` 文件。

相比之下，在 macOS 主机上搜索的位置是：
- 如果定义了环境变量 `HOME` ，则在其指向的目录中的 `Library/Preferences/gdb/gdbearlyinit` 文件。
- 如果定义了环境变量 `HOME` ，则在其指向的目录中的 `.gdbearlyinit` 文件。

可以使用 ` -nx` 或 ` -nh` 命令行选项防止加载主目录早期初始化文件，请参阅第 2.1.2 节[选择模式]，第 13 页。

#### 2.1.4.2 系统范围初始化文件

有两个位置被搜索以查找系统范围的初始化文件。这两个位置始终都会被检查：

`system.gdbinit`

这是一个单一的系统范围初始化文件。其位置由 `--with-system-gdbinit` 配置选项指定（请参阅第 C.6 节[系统范围配置]，第 755 页）。当 gdb 启动时，它首先被加载，在处理命令行选项之前。

`system.gdbinit.d`

这是系统范围的初始化目录。其位置由 `--with-system-gdbinit-dir` 配置选项指定（请参阅第 C.6 节[系统范围配置]，第 755 页）。当 gdb 启动时，在 `system.gdbinit` （如果启用）之后，立即按字母顺序加载此目录中的文件。文件需要具有已识别的脚本语言扩展名（`.py/.scm` ）或名为带有 `.gdb` 扩展名，才能被解释为常规的 gdb 命令。gdb 不会递归进入此目录的任何子目录。

可以使用 ` -nx` 命令行选项防止加载系统范围的初始化文件，请参阅第 2.1.2 节[选择模式]，第 13 页。

#### 2.1.4.3 主目录初始化文件

加载系统范围的初始化文件后，gdb 将在用户主目录中查找初始化文件 2 。gdb 将在主目录中搜索多个位置，这些位置按顺序搜索，gdb 将加载它找到的第一个文件，并且不会检查后续位置。

在非 Apple 主机上搜索的位置是：
```
$XDG_CONFIG_HOME/gdb/gdbinit
$HOME/.config/gdb/gdbinit
$HOME/.gdbinit
```
而在 Apple 主机上搜索的位置是：
```
$HOME/Library/Preferences/gdb/gdbinit
$HOME/.gdbinit
```
可以使用 ` -nx` 或 ` -nh` 命令行选项防止加载主目录初始化文件，请参阅第 2.1.2 节[选择模式]，第 13 页。

DJGPP 端口的 gdb 由于 DOS 文件系统对文件名的限制，使用 `gdb.ini` 而不是 `.gdbinit` 或 `gdbinit` 。Windows 端口的 gdb 使用标准名称，但如果在您的主目录中找到 `gdb.ini` 文件，它会警告您并建议将文件重命名为标准名称。

#### 2.1.4.4 本地目录初始化文件

gdb 将检查当前目录中名为 `.gdbinit` 的文件。它在处理除 ` -x` 和 ` -ex` 之外的命令行选项后最后加载。 ` -x` 和 ` -ex` 命令行选项在 `.gdbinit` 加载后最后处理，请参阅第 2.1.1 节[选择文件]，第 12 页。

如果当前目录中的文件已经作为主目录初始化文件加载，则不会再次加载。

可以使用 ` -nx` 命令行选项防止加载本地目录初始化文件，请参阅第 2.1.2 节[选择模式]，第 13 页。

## 2.2 退出 gdb

`quit [expression]`
`exit [expression]`
`q`

要退出 gdb ，使用 `quit` 命令（缩写为 `q` ）、 `exit` 命令，或者输入文件结束字符（通常是 `Ctrl-d` ）。如果您不提供 `expression` ，gdb 将正常终止；否则，它将使用 `expression` 的结果作为错误代码终止。

中断（通常是 `Ctrl-c` ）不会退出 gdb ，而是终止正在进行的任何 gdb 命令的操作，并返回 gdb 命令级别。在任何时候输入中断字符都是安全的，因为 gdb 只会在安全的时候才会让它生效。

如果您一直在使用 gdb 来控制附加的进程或设备，可以使用 `detach` 命令释放它（见第 4.7 节[调试已经运行的进程]，第 41 页）。

## 2.3 shell命令

如果在调试会话期间偶尔需要执行外壳命令，无需离开或暂停 gdb ；您可以直接使用 `shell` 命令。

`shell command-string`
`!command-string`

调用一个外壳来执行 `command-string` 。请注意，在 `!` 和 `command-string` 之间不需要空格。在 GNU 和 Unix 系统上，如果存在环境变量 `SHELL` ，则它确定要运行的外壳。否则，gdb 使用默认的外壳（在 GNU 和 Unix 系统上是 `/bin/sh` ，在 MS-Windows 上是 `cmd.exe` ，在 MS-DOS 上是 `COMMAND.COM` 等）。

您还可以使用 `$_shell` 便利函数从表达式中调用外壳命令。见[`$_shell` 便利函数]，第 176 页。

在开发环境中，经常需要使用 `make` 实用程序。在 gdb 中，您不必为此目的使用 `shell` 命令：

`make make-args`

使用指定的参数执行 `make` 程序。这等同于 `shell make make-args` 。

`pipe [command] | shell_command`
`| [command] | shell_command`
`pipe -d delim command delim shell_command`
`| -d delim command delim shell_command`

执行 `command` 并将其输出发送到 `shell_command` 。请注意，在 `|` 周围不需要空格。如果未提供 `command` ，则重复上次执行的命令。

如果 `command` 包含 `|` ，则可以使用 `-d delim` 选项指定一个替代的分隔符字符串 `delim` ，将 `command` 与 `shell_command` 分隔开。

示例：
```
(gdb) p var
$1 = {
black = 144,
red = 233,
green = 377,
blue = 610,
white = 987
}
(gdb) pipe p var|wc
7 19 80
(gdb) |p var|wc -l
7
(gdb) p /x var
$4 = {
black = 0x90,
red = 0xe9,
green = 0x179,
blue = 0x262,
white = 0x3db
}
(gdb) ||grep red
red => 0xe9,
(gdb) | -d! echo this contains a | char\n! sed -e ’s/|/PIPE/’
this contains a PIPE char
(gdb) | -d xxx echo this contains a | char!\n xxx sed -e ’s/|/PIPE/’
this contains a PIPE char!
(gdb)
```

便利变量 `$_shell_exitcode` 和 `$_shell_exitsignal` 可用于检查由 `shell` 、 `make` 、 `pipe` 和 `|` 启动的最后一个外壳命令的退出状态。见第 10.12 节[便利变量]，第 171 页。

## 2.4 记录输出

您可能希望将 gdb 命令的输出保存到文件中。有几个命令可用于控制 gdb 的记录。

`set logging enabled [on|off]`

启用或禁用记录。

`set logging file file`

更改当前日志文件的名称。默认的日志文件是 `gdb.txt` 。

`set logging overwrite [on|off]`

默认情况下，gdb 将附加到日志文件。如果您希望 `set logging enabled on` 覆盖日志文件而不是附加，请设置 `overwrite` 。

`set logging redirect [on|off]`

默认情况下，gdb 输出将同时发送到终端和日志文件。如果您希望输出仅发送到日志文件，请设置 `redirect` 。

`set logging debugredirect [on|off]`

默认情况下，gdb 调试输出将同时发送到终端和日志文件。如果您希望调试输出仅发送到日志文件，请设置 `debugredirect` 。

`show logging`

显示记录设置的当前值。

您还可以将 gdb 命令的输出重定向到外壳命令。见[管道]，第 20 页。