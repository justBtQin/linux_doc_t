# 34 使用历史记录交互

本章从用户的角度描述了如何交互使用 GNU 历史库。它应被视为用户指南。有关在自己的程序中使用 GNU 历史库的信息，请参阅 GNU 历史库中的“使用 GNU 历史编程”部分。

## 34.1 历史扩展

`History`库提供了类似于`csh`提供的历史扩展功能。本节描述用于操作历史信息的语法。

历史扩展将历史列表中的单词引入到输入流中，使得重复命令、将前一个命令的参数插入到当前输入行中或快速修复以前命令中的错误变得容易。

历史扩展分为两部分。第一部分是确定在替换期间应使用历史列表中的哪一行。第二部分是选择该行的部分内容以包含到当前行中。从历史记录中选择的行称为“事件”，该行中被处理的部分称为“单词”。有各种修饰符可用于操作所选的单词。行被拆分为单词的方式与`Bash`相同，因此被引号包围的几个单词被视为一个单词。

历史扩展由历史扩展字符的出现引入，默认情况下为“!”。

历史扩展实现了类似于 shell 的引用约定：反斜杠可用于取消下一个字符的特殊处理；单引号括住逐字序列的字符，可用于抑制历史扩展；双引号括起来的字符可能会受到历史扩展的影响，因为反斜杠可以转义历史扩展字符，但单引号不行，因为它们在双引号内不会被特殊处理。

### 34.1.1 事件指示符

事件指示符是对历史列表中命令行条目的引用。除非引用是绝对的，否则事件是相对于历史列表中的当前位置的。

```
!                   开始历史替换，除非后面跟着空格、制表符、行尾或‘=’。
!n                  引用命令行 n。
!-n                 引用前面 n 行的命令。
!!                  引用上一个命令。这是‘!-1’的同义词。
!string             引用历史列表中当前位置之前以 string 开头的最近命令。
!?string[?]         引用历史列表中当前位置之前包含 string 的最近命令。如果 string 后面紧跟换行符，则可以省略尾随的‘?’。如果 string 缺失，则使用最近一次搜索的字符串；如果没有之前的搜索字符串，则为错误。
^string1^string2^   快速替换。重复上一个命令，将 string1 替换为 string2。等同于!!:s^string1^string2^。
!#                  到目前为止输入的整个命令行。
```

### 34.1.2 Word Designators

Word designators 用于从事件中选择所需的单词。一个“:”将事件规范与单词设计符分隔开。如果单词设计符以“^”、“$”、“*”、“-”或“%”开头，则可以省略它。单词从行的开头开始编号，第一个单词用 0（零）表示。单词通过单个空格分隔插入到当前行中。

例如：

```
!!      表示前面的命令。当你输入此命令时，前面的命令将全部重复。
!!:$    表示前面命令的最后一个参数。这可以缩写为!$。
!fi:2   表示以字母“fi”开头的最近命令的第二个参数。
```

以下是单词设计符：

```
n       第 n 个单词。
^       第一个参数；即单词 1。
$       最后一个参数。
%       最近“?string?”搜索匹配的第一个单词，如果搜索字符串以构成单词的字符开头。
x-y     一个单词范围；“-y”缩写为“0-y”。
*       除了第 0 个单词之外的所有单词。这是“1-$”的同义词。如果事件中只有一个单词，使用“*”不是错误；在这种情况下，返回空字符串。
x*      缩写为“x-$”
x-      像“x*”一样缩写为“x-$”，但省略最后一个单词。如果“x”缺失，它默认为 0。
```

如果提供了单词设计符而没有事件规范，则使用前一个命令作为事件。

### 34.1.3 修饰符

在可选的单词指示符之后，你可以添加一个或多个以下修饰符的序列，每个修饰符前面都有一个“:”。这些修饰符或编辑从历史事件中选择的单词。

```
h：              删除尾随的路径名组件，只留下头部。
t：              删除所有前导的路径名组件，只留下尾部。
r：              删除后缀形式为“.suffix”的尾随部分，只留下basename。
e：              只保留尾随的后缀，删除其他所有部分。
p：              打印新命令，但不执行它。
s/old/new/：     在事件行中第一次出现的 old 处用 new 替换。可以使用任何字符作为分隔符来代替“/”。可以在 old 和 new 中用单个反斜杠引用分隔符。如果“&”出现在 new 中，它将被 old 替换。单个反斜杠将引用“&”。如果 old 为空，它将被设置为最后一次替换的 old，或者如果之前没有历史替换发生，将被设置为“!?string[?]”搜索中的最后一个字符串。如果 new 为空，每个匹配的 old 将被删除。如果最终分隔符是输入行上的最后一个字符，则它是可选的。
&：              重复上一次替换。
g:
a：              将更改应用于整个事件行。与“s”结合使用，如 gs/old/new/，或与“&”结合使用。
G：              对事件中的每个单词应用以下“s”或“&”修饰符一次。
```