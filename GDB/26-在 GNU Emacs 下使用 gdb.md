# 26 在 GNU Emacs 下使用 gdb

一个特殊的接口允许你使用 GNU Emacs 来查看（和编辑）你正在使用 gdb 调试的程序的源文件。

要使用这个接口，在 Emacs 中使用命令 M-x gdb。给出你想要调试的可执行文件作为参数。这个命令启动 gdb 作为 Emacs 的子进程，通过一个新创建的 Emacs 缓冲区进行输入和输出。

在 Emacs 下运行 gdb 与正常运行 gdb 类似，除了两件事：
```
• 所有“终端”输入和输出都通过一个 Emacs 缓冲区，称为 GUD 缓冲区。这既适用于 gdb 命令及其输出，也适用于你正在调试的程序的输入和输出。
	这很有用，因为这意味着你可以复制以前命令的文本并再次输入它们；你甚至可以以这种方式使用输出的部分。
	Emacs 的 Shell 模式的所有功能都可用于与你的程序交互。特别是，你可以以通常的方式发送信号 - 例如，C-c C-c 表示中断，C-c C-z 表示停止。

• gdb 通过 Emacs 显示源代码。
	每次 gdb 显示一个堆栈帧时，Emacs 会自动找到该帧的源文件，并在当前行的左边距处放置一个箭头（‘=>’）。Emacs 使用一个单独的缓冲区进行源显示，并分割屏幕以同时显示你的 gdb 会话和源代码。
	显式的 gdb 列表或搜索命令仍然像往常一样产生输出，但你可能没有理由从 Emacs 中使用它们。
```
我们称这种文本命令模式。Emacs 22.1 及更高版本还使用一种图形模式，默认启用，该模式提供了可以控制执行并描述你的程序状态的其他缓冲区。请参阅《GNU Emacs 手册》中的“GDB 图形界面”部分。

如果你在提示 M-x gdb 参数时指定了绝对文件名，那么 Emacs 将你的当前工作目录设置为你的程序所在的位置。如果你只指定文件名，那么 Emacs 将你的当前工作目录设置为与前一个缓冲区关联的目录。在这种情况下，gdb 可能会通过搜索你的环境的 PATH 变量来找到你的程序，但在某些操作系统上它可能无法找到源代码。因此，尽管 gdb 输入和输出会话正常进行，但辅助缓冲区不会显示当前源代码和执行行。

gdb 的初始工作目录打印在 GUD 缓冲区的顶行，这用作指定 gdb 要操作的文件的命令的默认值。请参阅第 18.1 节[指定文件的命令]，第 291 页。

默认情况下，M-x gdb 调用名为 gdb 的程序。如果你需要通过不同的名称调用 gdb（例如，如果你保留了几个具有不同名称的配置），你可以自定义 Emacs 变量 gud-gdb-command-name 来运行你想要的程序。

在 GUD 缓冲区中，除了标准的 Shell 模式命令外，你还可以使用这些特殊的 Emacs 命令：
```
C-h m 		描述 Emacs 的 GUD 模式的功能。
C-c C-s 	执行到另一个源行，类似于 gdb 的 step 命令；也会更新显示窗口以显示当前文件和位置。
C-c C-n 	执行到这个函数中的下一个源行，跳过所有函数调用，类似于 gdb 的 next 命令。然后更新显示窗口以显示当前文件和位置。
C-c C-i 	执行一条指令，类似于 gdb 的 stepi 命令；相应地更新显示窗口。
C-c C-f 	执行直到从所选堆栈帧退出，类似于 gdb 的 finish 命令。
C-c C-r 	继续执行你的程序，类似于 gdb 的 continue 命令。
C-c < 		根据数字参数指示的帧数向上移动（请参阅《GNU Emacs 手册》中的“数字参数”部分），类似于 gdb 的 up 命令。
C-c > 		根据数字参数指示的帧数向下移动，类似于 gdb 的 down 命令。
```
在任何源文件中，Emacs 命令 C-x SPC（gud-break）告诉 gdb 在当前所在的源行上设置一个断点。

在文本命令模式下，如果你输入 M-x speedbar，Emacs 会显示一个单独的框架，当 GUD 缓冲区是当前缓冲区时，它会显示一个回溯。将点移动到堆栈中的任何帧并按 RET 使其成为当前帧，并在源缓冲区中显示相关的源代码。或者，单击鼠标右键 2 使所选帧成为当前帧。在图形模式下，speedbar 显示观察表达式。

如果你不小心删除了源显示缓冲区，一个简单的恢复方法是在 gdb 缓冲区中输入命令 f，以请求一个帧显示；当你在 Emacs 下运行时，如果需要，这将重新创建源缓冲区以向你显示当前帧的上下文。

在 Emacs 中显示的源文件是在普通的 Emacs 缓冲区中，以通常的方式访问源文件。如果你愿意，你可以使用这些缓冲区编辑文件；但请记住，gdb 是根据行号与 Emacs 进行通信的。如果你从文本中添加或删除行，gdb 知道的行号将不再与代码正确对应。

关于 Emacs 与 gdb 的交互的更详细描述在 Emacs 手册中给出（请参阅《GNU Emacs 手册》中的“调试器”部分）。